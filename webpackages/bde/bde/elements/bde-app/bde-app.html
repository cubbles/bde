<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../vendor/iron-icons/iron-icons.html">
<link rel="import" href="../../vendor/iron-icons/editor-icons.html">
<link rel="import" href="../../vendor/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../vendor/paper-dialog/paper-dialog.html">
<link rel="import" href="../../vendor/paper-button/paper-button.html">
<link rel="import" href="../../vendor/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../vendor/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../vendor/paper-input/paper-input.html">
<link rel="import" href="../../vendor/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../vendor/paper-styles/paper-styles.html">
<link rel="import" href="../bde-manifest/bde-manifest.html">
<link rel="import" href="../bde-store-settings/bde-store-settings.html">
<link rel="import" href="../page-select-menu/page-select-menu.html">
<link rel="import" href="../bde-styles/bde-custom-icons.html">
<link rel="import" href="../bde-help-page/bde-help-page.html">
<link rel="import" href="../bde-explorer/bde-explorer.html">
<link rel="import" href="../bde-dataflow-view/bde-dataflow-view.html">
<link rel="import" href="../bde-design-view/bde-design-view.html">
<link rel="import" href="../bde-application-view/bde-application-view.html">
<link rel="import" href="../bde-repository-browser/bde-repository-browser.html">

<dom-module id="bde-app">
    <template>
        <style>
            :host {
                display: block;
                color: #404040;
                text-rendering: optimizeLegibility;

                @apply(--paper-font-common-base);
                @apply(--layout-fullbleed);
            }

            code,
            pre {
                @apply(--paper-font-code1);
            }

            a,
            a:link,
            a:active,
            a:hover,
            a:visited {
                text-decoration: none;
                color: inherit;
            }

            iron-pages {
                @apply(--layout-fit)
            }

            iron-pages > * {
                width: 100%;
                height: 100%;

                @apply(--layout);
                @apply(--layout-vertical);
            }

            paper-toolbar {
                @apply(--shadow-elevation-3dp);
            }

            .brand {
                float: left;
                padding: 10px 20px;
                font-size: 15px;
                font-weight: 700;
                line-height: 20px;
            }

            .brand > iron-icon {
                padding-right: .25em;
                color: var(--accent-color);
            }

            #bdeHeader {
                background-color: var(--paper-cyan-600);
                z-index: 10;
            }

            #bdeHeader > paper-icon-button {
                height: 35px;
            }

            #drawerPanel {
                --paper-drawer-panel-left-drawer-container: {
                    background-color: var(--paper-grey-100);
                    z-index: 1;
                    @apply(--shadow-elevation-2dp);
                };
            }

            #drawerPanel [drawer] {
                overflow-y: auto;
            }

            .storeUrlText {
                cursor: pointer;
            }

            .storeSettingsZone {
                padding-left: 10px;
                background-color: var(--paper-cyan-500);
            }

            .spinner-wrapper {
                @apply(--layout-fit);
                @apply(--layout-vertical);
                @apply(--layout-center-center);
            }

            .route-buttons[active] {
                color: #ff4081;
            }

            .route-buttons[focused] {
                color: #ff4081;
            }

            .route-buttons[ariaActiveAttribute = "aria-pressed"] {
              color: #ff4081;
            }

            .view-buttons{
                margin-right: 2.5em;
            }
        </style>

        <!-- Global application state -->
        <bde-manifest id="manifest"
                      name="{{manifest.name}}"
                      group-id="{{manifest.groupId}}"
                      version="{{manifest.version}}"
                      model-version="{{manifest.modelVersion}}"
                      doc-type="{{manifest.docType}}"
                      description="{{manifest.description}}"
                      author="{{manifest.author}}"
                      contributers="{{manifest.contributers}}"
                      license="{{manifest.license}}"
                      homepage="{{manifest.homepage}}"
                      keywords="{{manifest.keywords}}"
                      man="{{manifest.man}}"
                      runnables="{{manifest.runnables}}"
                      artifacts="{{manifest.artifacts}}"
        ></bde-manifest>

        <!-- App-wide components belong here -->
        <iron-localstorage id="appSettings"
                           name="app-settings"
                           value="{{settings}}"
                           on-iron-localstorage-load-empty="initializeDefaultSettings"
        ></iron-localstorage>

        <paper-dialog id="about"
                      exit-animation="fade-out-animation"
                      with-backdrop>
            <h2>About</h2>
            <div>
                <p>This is the Cubbles Browser Development Environment (BDE)</p>
                <!-- TODO (fdu): Automate version replacement from package.json -->
                <p>Version: [[bdeVersion]]</p>
                <p><a href="http://www.hm-ag.de/" target="_blank" alt="HM - Informatik AG">&copy; 2016 HM - Informatik
                    AG</a></p>
            </div>
            <div class="buttons">
                <paper-button dialog-confirm>Close</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="confirm"
                      exit-animation="fade-out-animation"
                      with-backdrop>
            <h2>Are You Sure?</h2>
            <div>
                <p>By creating a new Webpackage you'll be losing all of your work </p>
            </div>
            <div class="buttons">
                <paper-button dialog-confirm raised on-tap="newWebpackageBtnHandler">Confirm</paper-button>
                <paper-button dialog-dismiss raised>Cancel</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="deployDialog"
                      exit-animation="fade-out-animation"
                      with-backdrop>
            <h2>Under Construction</h2>
            <div>
                <p>This functionality is not yet implemented... </p>
            </div>
            <div class="buttons">
                <paper-button dialog-dismiss
                              >Cancel
                </paper-button>
            </div>
        </paper-dialog>

        <bde-help-page id="help"></bde-help-page>

        <bde-store-settings id="storeSettings"
                            settings="{{settings}}"
                            opened="{{settingsOpened}}">
        </bde-store-settings>

        <bde-repository-browser
                id="browser"
                settings="[[settings]]"
                url="[[computeBaseUrl(settings.baseUrl, settings.store, '/_design/couchapp-artifactsearch/_list/listArtifacts/viewArtifacts')]]"
                manifest="{{manifest}}"
                added-item="{{selectedArtifact}}"
        >
        </bde-repository-browser>

        <!-- Application UI -->
        <paper-header-panel mode="seamed">
            <paper-toolbar id="bdeHeader">
                <a href="#" class="brand">
                    <iron-icon icon="bde:cubbles"></iron-icon>
                    BDE</a>

                <paper-icon-button id="newWebpacakgeBtn"
                                   title="Create new webpackage..."
                                   aria-label="newWebpackage"
                                   icon="editor:insert-drive-file"
                                   on-tap="confirmationHandler"

                ></paper-icon-button>

                <paper-icon-button id="compoundBtn"
                                   title="Load from base..."
                                   aria-label="compounds"
                                   on-tap="getCompoundFromBase"
                                   icon="icons:cloud-download"
                ></paper-icon-button>

                <paper-icon-button id="deployBtn"
                                   title="Deploy..."
                                   aria-label="compounds"
                                   icon="icons:cloud-upload"
                                   on-tap="openDeployDialog"
                ></paper-icon-button>

                <div class="storeSettingsZone" on-tap="storeSettingsBtnHandler">
                    <span class="storeUrlText">[[settings.baseUrl]]/[[settings.store]]</span>
                    <paper-icon-button id="storeBtn"
                                       title="Change store..."
                                       aria-label="store"
                                       icon="icons:create"
                    ></paper-icon-button>
                </div>

                <span class="flex"></span>

                <page-select-menu selected="{{selectedPage}}" class="view-buttons">
                    <paper-icon-button id="flowIcon"
                                       page="dataflowView"
                                       title="change to dataflow-view"
                                       icon="gesture"
                                       class="route-buttons"
                                       on-tap = "activateFlow"
                                       selected
                    ></paper-icon-button>

                    <paper-icon-button id="designIcon"
                                       page="designView"
                                       title="change to design-view"
                                       icon="open-with"
                                       class="route-buttons"
                                       on-tap="activateDesign"

                    ></paper-icon-button>

                    <paper-icon-button id="appIcon"
                                       page="applicationView"
                                       title="change to application-view"
                                       icon="apps"
                                       class="route-buttons"
                                       on-tap="activateApp"

                    ></paper-icon-button>
                </page-select-menu>

                <paper-icon-button id="aboutBtn"
                                   title="About..."
                                   aria-label="about"
                                   icon="icons:copyright"
                                   on-tap="aboutBtnHandler"
                ></paper-icon-button>

                <paper-icon-button id="helpBtn"
                                   title="Help Page"
                                   aria-label="help"
                                   icon="icons:help-outline"
                                   on-tap="helpBtnHandler"
                ></paper-icon-button>
            </paper-toolbar>
            <div class="spinner-wrapper" hidden="[[!loading]]">
                <paper-spinner id="spinner" active></paper-spinner>
            </div>

            <paper-drawer-panel id="drawerPanel"
                                drawer-width="300px"
                                hidden="[[loading]]"
                                force-narrow="[[!showExplorer]]"
                                disable-swipe
                                disable-edge-swipe>
                <div drawer>
                    <bde-explorer id="explorer"
                                  manifest="{{manifest}}"
                                  selected-compound="{{selectedArtifact}}"
                                  current-component-metadata="{{currentComponentMetadata}}"
                    ></bde-explorer>
                </div>
                <div main>
                    <iron-pages id="pages"
                                attr-for-selected="id"
                                selected="{{selectedPage}}">
                        <bde-dataflow-view id="dataflowView"
                                           current-component-metadata="{{currentComponentMetadata}}"
                                           settings="{{settings}}"
                                           >
                        </bde-dataflow-view>

                        <bde-design-view id="designView"
                                         current-component-metadata="[[currentComponentMetadata]]"
                                         bde-version="[[bdeVersion]]"
                                         settings="[[settings]]"
                                         selected-page = "{{selectedPage}}">
                        </bde-design-view>

                        <bde-application-view id="applicationView"
                                              loaded="{{applicationViewLoaded}}"
                                              current-component-metadata="{{currentComponentMetadata}}"
                                              settings="{{settings}}"
                        ></bde-application-view>
                    </iron-pages>
                </div>
            </paper-drawer-panel>
        </paper-header-panel>
    </template>

    <script> 
    /*global XMLHttpRequest*/
    (function () {
      'use strict';

      Polymer({
        is: 'bde-app',

        properties: {
          currentComponentMetadata: {
            type: Object,
            value: function () {
              return {
                manifest: null,
                endpointId: null,
                artifactId: null
              };
            },
            notify: true
          },

          manifest: {
            type: Object
          },

          screenHeight: {
            type: Number,
            value: function () {
              return window.outerHeight;
            }
          },

          screenWidth: {
            type: Number,
            value: function () {
              return window.outerWidth;
            }
          },

          selectedPage: {
            type: String,
            value: 'dataflowView',
            observer: "selectedPageChanged"
          },

          settings: {
            type: Object
          },

          showExplorer: {
            type: Boolean,
            value: true
          },

          selectedArtifact: {
            type: Object
          },

          loading: {
            type: Boolean,
            value: false
          },

          bdeVersion: {
            type: String,
            value: 'unknown'
          }
        },

        listeners: {
          'graph-needs-update': 'handleGraphUpdate',
          'bde-manifest-loaded': 'handleLoaded',
          'bde-manifest-loading': 'handleLoading',
          'bde-member-loaded': 'handleLoaded',
          'bde-member-loading': 'handleLoading',
          'iron-select': '_handlePageSelect',
          'iron_deselect': '_handlePageDeselect',
          'bde-dataflow-view-reload-required': '_handleBdeDataflowViewReloadRequired'
        },


        attached: function () {
          // Bind webpackage node to local scope
          this.set('manifest', this.$.manifest);

          // Show the Explorer
          this.$.drawerPanel.openDrawer();

          // Attach resize listener
          // (cannot use listeners for window events)
          window.addEventListener('resize', this.handleResize.bind(this));
        },

        ready: function () {
          this.loadBdeVersion();
        },

        selectedPageChanged: function (newpage, oldpage) {
          if(!newpage) {
            return;
          }
          if (newpage === "dataflowView"){
            this.activateFlow();
          }
        },

        computeBaseUrl: function (baseUrl, store, partial) {
          if (!partial || typeof partial !== 'string') {
            throw new TypeError('`partial` must be a string');
          }

          // Make sure partial starts with a slash
          partial = partial.replace(/^\/?/, '/');

          try {
            return baseUrl + '/' + store + partial;
          } catch (e) {
            return '';
          }
        },

        handleGraphUpdate: function () {
          this.$.dataflowView.rerender();
        },

        handleLoading: function () {
          this.loading = true;
        },

        handleLoaded: function () {
          this.loading = false;
        },

        handleResize: function (event) {
          this.set('screenWidth', window.outerWidth);
          this.set('screenHeight', window.outerHeight);
        },

        loadManifest: function (manifest) {
          this.$.manifest.loadManifest(manifest);
        },

        getCompoundFromBase: function () {
          this.$.browser.compoundOnly = true;
          // this.$.parser.showCompoundMembers = true;
          this.$.browser.toggleDialog();
        },

        _computeAddComponent: function (sidebar) {
          return (sidebar) ? 'push-right' : '';
        },

        _concatArray: function () {
          return [].concat.apply(this, arguments);
        },

        _handleBdeDataflowViewReloadRequired: function () {
          this.$.dataflowView.reload();
        },
        _handlePageSelect: function (event) {
          if (event.detail.item.id === 'applicationView') {
            event.detail.item.set('active', true);
          }
          if (event.detail.item.id === 'dataflowView') {
            this._resizeView(event.detail.item);
          }
        },
        _handlePageDeselect: function (event) {
          if (event.detail.item.id === 'applicationView') {
            event.detail.item.set('active', false);
          }
        },

        _resizeView: function (view) {
          view.handleResize();
        },

        storeSettingsBtnHandler: function () {
          this.$.storeSettings.opened = !this.$.storeSettings.opened;
        },

        aboutBtnHandler: function () {
          this.$.about.opened = !this.$.about.opened;
        },

        helpBtnHandler: function () {
          this.$.help.opened = !this.$.help.opened;
        },

        confirmationHandler: function () {
          this.$.confirm.opened = !this.$.confirm.opened;
        },

        openDeployDialog: function () {
          this.$.deployDialog.opened = !this.$.deployDialog.opened;
        },

        newWebpackageBtnHandler: function () {
          this.resetBDE();
        },

        resetBDE: function () {
          document.querySelector('#manifest').reset();
        },

        initializeDefaultSettings: function () {
          this.set('settings', {
            baseUrl: 'https://cubbles.world',
            store: 'sandbox'
          });
        },

        loadBdeVersion: function () {
          var xhr = new XMLHttpRequest();
          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                this.set('bdeVersion', JSON.parse(xhr.responseText).version);
              } else {
                console.error('BDE version could no be determined. Error loading bde  manifest. Request returned a status of ' + xhr.status);
              }
            }
          }.bind(this);
          xhr.open('GET', '../manifest.webpackage', true);
          xhr.send();
        },
        activateFlow: function () {
          this.$.flowIcon.setAttribute("ariaActiveAttribute", "aria-pressed");
          this.$.designIcon.setAttribute("ariaActiveAttribute", "aria-not-pressed");
          this.$.appIcon.setAttribute("ariaActiveAttribute", "aria-not-pressed");
        },

        activateDesign: function () {
          this.$.flowIcon.setAttribute("ariaActiveAttribute", "aria-not-pressed");
          this.$.designIcon.setAttribute("ariaActiveAttribute", "aria-pressed");
          this.$.appIcon.setAttribute("ariaActiveAttribute", "aria-not-pressed");
        },

        activateApp: function () {
          this.$.flowIcon.setAttribute("ariaActiveAttribute", "aria-not-pressed");
          this.$.designIcon.setAttribute("ariaActiveAttribute", "aria-not-pressed");
          this.$.appIcon.setAttribute("ariaActiveAttribute", "aria-pressed");
        }
      });
    })();

    </script>

</dom-module>
