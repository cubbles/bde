<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../vendor/paper-dialog/paper-dialog.html">
<link rel="import" href="../../vendor/paper-toast/paper-toast.html">
<link rel="import" href="../../vendor/paper-spinner/paper-spinner.html">

<!-- -->
<dom-module id="bde-application-view">

    <style is="custom-style">

        :host {
            display: block;
            height: 100%;
        }

        iframe {
            display: block;
            width: 100%;
            height: 100vh;
        }

            iframe.hidden {
                visibility: hidden;
                display: none;
            }

        .spinner-wrapper {
            @apply(--layout-fit);
            @apply(--layout-vertical);
            @apply(--layout-center-center);
        }

        paper-button{
          color: #1DB1CC;
        }

        .hint {
            padding: .5em 0;
            color: var(--secondary-text-color);

            @apply(--paper-font-subhead);
        }

            .hint a {
                text-decoration: none;
                color: var(--accent-color);
            }

    </style>

    <template>

        <div class="spinner-wrapper" hidden="[[loaded]]">
            <paper-spinner id="spinner" active></paper-spinner>
            <span class="hint">Complete <a href="javascript:void(0)" on-tap="openProjectProperties">project settings</a> and add some cubbles</span>
        </div>

        <iframe
            id="iframe"
            class$="[[_computeIFrameClasses(loaded)]]"
            src="cif-iframe/cif-iframe.html"
            frameborder="0"
            seamless
            hidden="[[!loaded]]">
        </iframe>

        <paper-toast
            id="noProjPropToast"
            text="Manifest incomplete!"
            duration="5000">
          <paper-button on-click="openProjectProperties">Edit Project Properties</paper-button>
        </paper-toast>

        <paper-toast
            id="noMembersToast"
            text="Manifest incomplete! Add Members first."
            duration="5000">
        </paper-toast>

    </template>

    <script>
    (function () {
        'use strict';

        // window.addEventListener('message', console.log.bind(console));

        Polymer({

            is: 'bde-application-view',

            properties: {

                loaded: {
                    type: Boolean,
                    value: false,
                    notify: true
                },

                currentComponentMetadata: {
                    type: Object
                },
                settings: {
                    type: Object
                }

            },

            observers: [
                    'currentComponentMetadataChanged(currentComponentMetadata.*)'
            ],

            created: function () {

                // Polymer does not let me bind to window in `listeners`
                window.addEventListener('message', this.handleMessage.bind(this), false);

            },

            ready: function () {
                this.parentNode.addEventListener('iron-select', this.entryHandler);
            },

            handleMessage: function (event) {
                var data = event.data || {};

                if (!data || !data.message) {
                    return;
                }

                switch (data.message) {

                    case 'loaded':
                        this.loaded = true;
                        console.log("`loaded` event from iframe");
                    break;

                }

            },
            entryHandler: function(e){
                var applicationView = e.detail.item;
                if (applicationView.id !== 'applicationView'){
                    return;
                }
                applicationView.currentComponentMetadataChanged();
            },
            currentComponentMetadataChanged: function () {
                if (!this.currentComponentMetadata || !this.currentComponentMetadata.manifest
                        || !this.currentComponentMetadata.artifactId || !this.currentComponentMetadata.endpointId){
                    return;
                }
                this.currentComponentMetadata.settings = this.settings;
                this.reloadIframe(() => {
                    this._postMessage('currentComponentMetadata', this.currentComponentMetadata);
                });
            },

            reloadIframe: function (cb) {

                this.loaded = false;

                this.$.iframe.onload = cb.bind(this);
                this.$.iframe.contentWindow.location.reload();

            },

            _computeIFrameClasses: function (loaded) {
                return (!loaded) ? 'hidden': 'visible';
            },

            _postMessage: function (message, data) {
                this.debounce('postMessage', () => {
                    var payload = { 'message': message };

                    if (data) { payload.data = data; }

                    this.$.iframe.contentWindow.postMessage(
                        JSON.parse(JSON.stringify(payload)),
                        document.location.origin
                    );
                }, 250);
            }


        });
    }());
    </script>

</dom-module>
