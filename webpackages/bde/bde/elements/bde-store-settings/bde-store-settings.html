<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/iron-form/iron-form.html">
<link rel="import" href="../../vendor/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../vendor/iron-pages/iron-pages.html">
<link rel="import" href="../../vendor/paper-toast/paper-toast.html">
<link rel="import" href="../../vendor/paper-dialog/paper-dialog.html">
<link rel="import" href="../../vendor/paper-tabs/paper-tabs.html">
<link rel="import" href="../../vendor/paper-input/paper-input.html">
<link rel="import" href="../../vendor/paper-button/paper-button.html">
<link rel="import" href="../../vendor/neon-animation/animations/fade-out-animation.html">

<dom-module id="bde-store-settings">
    <template>
        <style>
            :host {
                display: block;
            }

            #dialog {
                min-width: 500px;
            }

            .content {
                padding-bottom: 20px;
            }

            fieldset {
                border: 0;
                margin: 0;
                padding: 0;
            }

            paper-tabs {
                background-color: var(--light-theme-background-color);
                --paper-tabs-selection-bar-color: var(--accent-color);
            }

            .errorMessage{
                background: #EEEEEE;
                color: #DD2C00;
                padding: 20px;
            }
        </style>

        <paper-toast id="toast" no-auto-focus></paper-toast>

        <paper-dialog id="formDialog" opened="{{opened}}" exit-animation="fade-out-animation" with-backdrop>

                <h2>Change Store</h2>

                <div class="errorMessage" id="errorMessageDiv" hidden="[[validSettings]]"></div>

                <p class="description">
                    Provide the data of the store you want to use to retrieve and upload the components.
                </p>

            <form is="iron-form" id="storeForm">
                <paper-input id="baseUrl"
                             type="text"
                             name="baseUrl"
                             label="Base URL"
                             pattern="^(https?)://[^\s\/$.?#].[^\s]*$"
                             value="[[_intermediate.baseUrl]]"
                             error-message="Please provide a valid Store sase url, e.g. 'https://cubbles.world'"
                             autofocus
                             required
                             auto-validate
                             on-keyDown="confirmBaseURL">
                </paper-input>

                <paper-input id="storeName"
                             type="text"
                             name="store"
                             label="Store Name"
                             pattern="[a-zA-Z0-9-._~]+"
                             value="[[_intermediate.store]]"
                             error-message="Please provide a valid Store name, e.g. 'bde'"
                             required
                             auto-validate
                             on-keyDown="saveChanges">
                </paper-input>

                <p>
                    <strong>Note: </strong> Changing the store will re-initialize the application. Any changes on the
                    current active webpackage will be lost.
                </p>
            </form>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button on-tap="validateStoreSettings">Change</paper-button>
            </div>
        </paper-dialog>
    </template>
    
    <script>
    Polymer({
      is: 'bde-store-settings',

      properties: {

        opened: {
          type: Boolean,
          value: false
        },

        settings: {
          type: Object,
          notify: true
        },

        requestSuccess: {
          type: Boolean
        },

        validSettings: {
          type: Boolean,
          value: true
        }

      },

      listeners: {
        'iron-overlay-opened': 'handleOpened'
      },

      confirmBaseURL: function (e) {
        if(e.keyCode === 13) {
          this.$.storeName.focus();
        }
      },

      saveChanges: function (e) {
        if(e.keyCode === 13) {
          this.validateStoreSettings();
        }
      },

      handleOpened: function () {
        this.set('_intermediate', JSON.parse(JSON.stringify(this.settings)));
        this.set('validSettings', true);
      },

      validateStoreSettings: function (e) {
        if (this.$.storeForm.validate()) {
          var changeBaseUrl;
          var changeStoreName;
          if (this.settings.store !== this.$.storeName.value) {
            changeStoreName = true;
          }
          if (this.settings.baseUrl !== this.$.baseUrl.value) {
            changeBaseUrl = true;
          }
          if (changeBaseUrl || changeStoreName) {
            this.testStoreConnection(function () {
              if (this.requestSuccess) {
                this.changeStore(changeBaseUrl, changeStoreName);
                this.$.formDialog.close();
                this.showNotification('Store changed');
              } else {
                this.showErrorMessage('Store url is not valid. The connection test was unsuccessful');
              }
            }.bind(this));
          } else {
            this.showErrorMessage('The provided Store url is the same as the current one');
          }
        }
      },

      changeStore: function (changeBaseUrl, changeStoreName) {
        if (changeStoreName) {
          this.set('settings.' + this.$.storeName.name, this.$.storeName.value);
        }
        if (changeBaseUrl) {
          this.set('settings.' + this.$.baseUrl.name, this.$.baseUrl.value);
        }
        document.querySelector('bde-app').resetBDE();
      },

      showErrorMessage: function (message) {
        this.$.errorMessageDiv.innerHTML = message;
        this.set('validSettings', false);
      },

      showNotification: function (message) {
        this.$.toast.text = message;
        this.$.toast.open();
      },

      testStoreConnection: function (callback) {
        var xhr = new XMLHttpRequest();
        var self = this;
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              self.requestSuccess = true;
            } else {
              self.requestSuccess = false;
            }
            callback.apply(xhr);
          }
        };
        xhr.open('GET', this.$.baseUrl.value + '/' + this.$.storeName.value, true);
        xhr.send();
      }
    });
    </script>
</dom-module>
