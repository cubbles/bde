<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/paper-input/paper-input.html">
<link rel="import" href="../../vendor/paper-input/paper-textarea.html">
<link rel="import" href="../../vendor/paper-input/paper-input.html">
<link rel="import" href="../../vendor/paper-dialog/paper-dialog.html"/>
<link rel="import" href="../../vendor/paper-checkbox/paper-checkbox.html" />
<link rel="import" href="../../vendor/paper-dialog-scrollable/paper-dialog-scrollable.html" />
<link rel="import" href="../../vendor/iron-form/iron-form.html" />

<dom-module id="bde-slot-init-dialog">
    <template>
        <style>
            paper-dialog {
                position: fixed;
                top: 20vh;
                left: 50vw;
                min-width: 500px;
                /**
                 * The 3D-transformation fixes a strange rendering bug, whereas the dialog will
                 * be hidden behind the-graph after opening.
                 * This is dark magic and to be removed if no longer needed. (fdu)
                 */
                transform: translate3d(-50%, 0, 0);
                -webkit-transform: translate3d(-50%, 0, 0);
                -ms-transform: translate3d(-50%, 0, 0);
            }

            paper-checkbox .subtitle {
                display: block;
                font-size: 0.8em;
                margin-top: 2px;
                max-width: 150px;
            }
        </style>
        <paper-dialog id="initDialog" opened="{{dialogOpened}}" no-cancel-on-esc-key="true">
            <h2>Initialiser for <code>[[slot.slotId]]</code></h2>
            <p>Set the initial slot value here.</p>
            <paper-dialog-scrollable>
                <form is="iron-form" on-iron-form-presubmit="onPreSubmit">
                    <paper-input label="Description" type="Text" value="{{_initialiser.description}}"></paper-input>
                    <paper-checkbox hidden$="[[!_slotIsBoolean(slot)]]" checked="[[_serializeBoolean(_initialiser.value)]]">
                        Enabled
                        <span class="subtitle">Initial Value</span>
                    </paper-checkbox>
                    <paper-input hidden$="[[!_slotIsNumber(slot)]]" label="Initial Value" type="Number" value="{{_initialiser.value}}"></paper-input>
                    <paper-input hidden$="[[!_slotIsText(slot)]]" label="Initial Value" value="{{_initialiser.value}}"></paper-input>
                    <paper-textarea id="otherInitValue" hidden$="[[!_slotIsOther(slot)]]" label="Initial Value" value="{{_serializeOther(_initialiser.value)}}"></paper-textarea>
                </form>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm>Save</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>
    Polymer({
      is: 'bde-slot-init-dialog',
      properties: {
        slot: {
          type: Object,
          notify: true
        },
        memberId: {
          type: Object
        },
        dialogOpened: {
          type: Boolean,
          notify: true
        },
        _initialiser: {
          type: Object
        },
        /**
         * indicate the slot is a own slot of the shown component, and initialiser shoudn't have the property memberIdRef
         */
        ownSlot: {
          type: Boolean,
          value: false
        },

        artifact: {
          type: Object,
          notify: true
        }

      },
      listeners: {
        'initDialog.iron-overlay-closed': '_handleDialogClosed',
        'initDialog.iron-overlay-opened': '_handleDialogOpened',
        'otherInitValue.change': '_handleOtherInitValueChanged'
      },

      onKeydown: function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          // this.set('initialiser.description', event.target.textContent);
          event.target.blur();
        }
      },

      onPreSubmit: function (event) {
        // Don't try to send the form
        event.preventDefault();
      },

      _findInitializer: function (slot) {
        // TODO fÃ¼r ownSlots anpassen
        var init;
        if (this.artifact.inits) {
          init = this.artifact.inits.find(function (init) {
            return init.memberIdRef === this.memberId &&
              init.slot === slot.slotId;
          }, this);
        }
        // var info = {};
        // var path = new Polymer.Collection(this.artifact.inits).getKey(init);
        // var arrayPath = this._get('this.artifact.inits' + path, this, info);
        // this.linkPaths(initializer, info.path);
        return init;
      },

      _handleDialogOpened: function (event) {
        // Create a temporare initialiser object for the dialog
        var newInitialiser = {

          slot: this.slot.slotId,
          description: '',
          value: null
        };

        var init = this._findInitializer(this.slot);
        if (!this.ownSlot) {
          newInitialiser.memberIdRef = this.memberId;
        }
        if (init && init.description) {
          newInitialiser.description = init.description;
        }
        if (init && init.value) {
          newInitialiser.value = init.value;
        }
        this.set('_initialiser', newInitialiser);
      },

      _handleDialogClosed: function (event) {
        if (event.detail.confirmed) {
          this._saveEditedInit();
        }
      },
      _handleOtherInitValueChanged: function (event) {
        this._initialiser.value = JSON.parse(this.$.otherInitValue.value);
      },
      _saveEditedInit: function () {
        var init = this._findInitializer(this.slot);
        if (!init) {
          if (this._initialiser.description.length === 0) {
            delete this._initialiser.description;
          }
          if (!this.artifact.inits) {
            this.artifact.inits = [];
          }
          this.push('artifact.inits', this._initialiser);
        } else {
          var path = Polymer.Collection.get(this.artifact.inits).getKey(init);
          if (this._initialiser.description && this._initialiser.description.length > 0) {
            this.set('artifact.inits.' + path + '.description', this._initialiser.description);
          }
          this.set('artifact.inits.' + path + '.value', this._initialiser.value);
        }
      },

      _serializeBoolean: function (value) {
        return value ? 'checked' : '';
      },

      _serializeOther: function (value) {
        return JSON.stringify(value, null, 2);
      },

      _slotIsBoolean: function (slot) {
        return slot.type.toLowerCase() === 'boolean';
      },

      _slotIsNumber: function (slot) {
        return slot.type.toLowerCase() === 'number';
      },

      _slotIsText: function (slot) {
        return slot.type.toLowerCase() === 'string';
      },

      _slotIsOther: function (slot) {
        return !this._slotIsBoolean(slot) && !this._slotIsNumber(slot) && !this._slotIsText(slot);
      }

    });
</script>
</dom-module>
