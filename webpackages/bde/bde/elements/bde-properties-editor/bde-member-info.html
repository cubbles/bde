<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/iron-icons/iron-icons.html">
<link rel="import" href="bde-slot-info.html">
<link rel="import" href="bde-member-edit-dialog.html" />

<dom-module id="bde-member-info">
  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <bde-member-edit-dialog id="bdeMemberDialog" artifact="[[artifact]]" member="{{member}}" dialog-opened="{{memberDialogOpened}}"></bde-member-edit-dialog>

    <h2>[[_memberName]] <paper-icon-button icon="icons:settings" active="{{memberDialogOpened}}" toggles></paper-icon-button></h2>

    <p contenteditable="true" on-input="onDescriptionChange">[[member.description]]</p>

    <div class="listbox" hidden$="[[!_hasSlots(member)]]">
      <template is="dom-repeat" items="[[member.metadata.slots]]" filter="_filterInslots" as="slot">
        <bde-slot-info slot="{{slot}}" direction="input" artifact="{{artifact}}" member-id="[[member.memberId]]" on-change="onInSlotChange"></bde-slot-info>
      </template>

      <template is="dom-repeat" items="[[member.metadata.slots]]" filter="_filterOutslots" as="slot">
        <bde-slot-info slot="{{slot}}" direction="output" on-change="onOutSlotChange"></bde-slot-info>
      </template>
    </div>

  </template>

  <script>
  Polymer({
    is: 'bde-member-info',

    properties: {
      artifact: {
        type: Object,
        notify: true
      },
      member: {
        type: Object,
        notify: true
      },
      memberDialogOpened: {
        type: Boolean
      },
      _dummy: {
        type: String
      },
      _memberName: {
        type: String,
        // dummy attribute for notify changes in deep properties
        computed: '_getMemberName(member, _dummy)'
      }
    },

    observers: [
      'memberPropsChanged(member.*)'
    ],

    handleSlotChange: function (event) {

    },

    memberPropsChanged: function (changeRecord) {
      // set dumme attribute for signalise a change in dep properties for the computed property _memberName
      this.set('_dummy', new Date().getTime());
      if (this.member && changeRecord.path === 'member.displayName') {
        var key = Polymer.Collection.get(this.artifact.members).getKey(this.member);
        this.set('artifact.members.' + key + '.displayName', this.member.displayName);
      }
    },

    onDescriptionChange: function (event) {
      this.set('member.description', event.target.textContent);
    },

    onInSlotChange: function (event) {

    },

    onOutSlotChange: function (event) {

    },

    onNameChange: function (event) {
      this.set('member.displayName', event.target.textContent);
    },

    _filterInslots: function (slot) {
      return (slot.direction.indexOf('input') !== -1);
    },

    _filterOutslots: function (slot) {
      return (slot.direction.indexOf('output') !== -1);
    },

    _getMemberName: function (member) {
      return member ? member.displayName || member.memberId : '';
    },

    _hasSlots: function (member) {
      return (member && member.metadata && member.metadata.slots && member.metadata.slots.length && member.metadata.slots.length > 0);
    },

    _slotIsBoolean: function (slot) {
      return slot.type === 'boolean';
    },

    _slotIsNumber: function (slot) {
      return slot.type === 'number';
    },

    _slotIsOther: function (slot) {
      return !this._slotIsBoolean(slot) && !this._slotIsNumber(slot) && !this._slotIsText(slot);
    },

    _slotIsText: function (slot) {
      return slot.type === 'string';
    }
  });
  </script>

</dom-module>
