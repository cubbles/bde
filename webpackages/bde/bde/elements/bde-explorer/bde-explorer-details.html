<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/iron-collapse/iron-collapse.html">
<link rel="import" href="../../vendor/iron-icons/iron-icons.html">
<link rel="import" href="../../vendor/paper-dialog/paper-dialog.html">
<link rel="import" href="../../vendor/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../vendor/paper-input/paper-input.html">
<link rel="import" href="../../vendor/paper-input/paper-textarea.html">
<link rel="import" href="../../vendor/paper-button/paper-button.html">
<link rel="import" href="../../vendor/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../vendor/paper-icon-button/paper-icon-button.html">

<dom-module id="bde-explorer-details">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-dialog {
                width: 45vw;
                top: 60px;
            }

            paper-checkbox {
                margin-top: 10px;
                margin-bottom: 10px;
                margin-right: 10px;
            }

            .collapse-content {
                padding: 10px;
            }

            .collapse-header {
                font-weight: bold;
                cursor: pointer;
            }

            .main-collapse-header {
                font-size: medium;
                margin-top: 15px;
            }

            .list-item-container {
                border-style: solid;
                border-width: 1px;
                padding: 10px;
                border-color: #dbdbdb;
                margin-top: 10px;
            }

            .addItem {
                cursor: pointer;
            }
        </style>

        <paper-dialog id="dialog" opened="{{opened}}">

            <h2><span>[[artifact.artifactId]]</span></h2>

            <paper-input tabindex="-1"
                         label="Artifact id"
                         pattern="^[a-z0-9]+(-[a-z0-9]+)+"
                         placeholder="A name for this artifact - unique within the webpackage."
                         required
                         auto-validate
                         value="{{artifact.artifactId}}">
            </paper-input>

            <paper-dialog-scrollable>
                <!-- Description -->
                <paper-textarea tabindex="-1"
                                label="description"
                                placeholder="Description of this artifact: responsibility, usage scenarios."
                                value="{{artifact.description}}">
                </paper-textarea>

                <div tabindex="0"
                     on-tap="toggleCollapse"
                     data-collapse-id="runnablesCollapse"
                     class="main-collapse-header collapse-header">
                    <span title="Resources that are actually runnable in a user webbrowser.">Runnables</span>
                    <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                </div>
                <iron-collapse id="runnablesCollapse">
                    <div class="collapse-content">
                        <template is="dom-repeat" id="runnables" items="{{artifact.runnables}}" as="runnable">
                            <div>
                                <div tabindex="0"
                                     on-tap="toggleCollapse"
                                     class="collapse-header"
                                     data-collapse-id$="[[_idForCollapse(index, 'runnable_')]]">
                                    <span>[[runnable.name]]</span>
                                    <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                                </div>
                                <iron-collapse id$="[[_idForCollapse(index, 'runnable_')]]">
                                    <div class="collapse-content">
                                        <paper-input label="Name"
                                                     placeholder="A (short) name for the runnable."
                                                     pattern="^(.)+"
                                                     required
                                                     value="{{runnable.name}}">
                                        </paper-input>
                                        <paper-input label="Path"
                                                     placeholder="Path to the 'runnable' resource - relative to the webpackage itself (e.g. '/doc/index.html')."
                                                     pattern="^/(.)+"
                                                     required
                                                     value="{{runnable.path}}">
                                        </paper-input>
                                        <paper-textarea label="Description"
                                                        placeholder="Short description of the runnable: short content description, target group etc."
                                                        value="{{runnable.label}}">
                                        </paper-textarea>
                                    </div>
                                </iron-collapse>
                            </div>
                        </template>
                        <paper-icon-item class="addItem" on-tap="addRunnable">
                            <iron-icon icon="icons:add" item-icon></iron-icon>
                            <paper-item-body>
                                <div>Add Runnable</div>
                            </paper-item-body>
                        </paper-icon-item>
                    </div>
                </iron-collapse>

                <template is="dom-if" if="[[_artifactIsCompound(artifact)]]">
                    <div tabindex="0"
                         on-tap="toggleCollapse"
                         data-collapse-id="endpointsCollapse"
                         class="main-collapse-header collapse-header">
                        <span title="1..n endpoints other artifacts can refer to. A 'main' -artifactEndpoint is required.">Endpoints</span>
                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                    </div>
                    <iron-collapse id="endpointsCollapse">
                        <div class="collapse-content">
                            <template is="dom-repeat" id="endpoints" items="[[artifact.endpoints]]" as="endpoint">
                                <div>
                                    <div tabindex="0"
                                         on-tap="toggleCollapse"
                                         class="collapse-header"
                                         data-collapse-id$="[[_idForCollapse(index, 'endpoint_')]]">
                                        <span>[[endpoint.endpointId]]</span>
                                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                                    </div>
                                    <iron-collapse id$="[[_idForCollapse(index, 'endpoint_')]]">
                                        <div class="collapse-content">
                                            <paper-input label="Endpoint Id"
                                                         placeholder="Identifier for this slot item - unique within this component."
                                                         pattern="^[a-z0-9-]+"
                                                         required
                                                         value="{{endpoint.endpointId}}">
                                            </paper-input>
                                            <paper-textarea label="Description"
                                                            placeholder="Description of this endpoint: What does the endpoint provide? When to use? etc."
                                                            value="{{endpoint.description}}">
                                            </paper-textarea>

                                            <div tabindex="0"
                                                 on-tap="toggleCollapse"
                                                 class="collapse-header"
                                                 data-collapse-id$="[[_idForCollapse(index, 'endpoint_resources_')]]">
                                                <span title="Contains the first-level resources of this endpoint.">Resources</span>
                                                <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                                            </div>
                                            <iron-collapse id="[[_idForCollapse(index, 'endpoint_resources_')]]">
                                                <div class="collapse-content">
                                                    <template is="dom-repeat"
                                                              id="resources"
                                                              items="[[endpoint.resources]]"
                                                              as="resource">
                                                        <div class="list-item-container">
                                                            <template is="dom-if" if="[[_isObject(resource)]]">
                                                                <paper-input label="Prod"
                                                                             placeholder="Path to potentially optimized resource."
                                                                             required
                                                                             value="{{resource.prod}}">
                                                                </paper-input>
                                                                <paper-input label="Dev"
                                                                             placeholder="Path to resource for development."
                                                                             required
                                                                             value="{{resource.dev}}">
                                                                </paper-input>
                                                            </template>
                                                            <template is="dom-if" if="[[!_isObject(resource)]]">
                                                                <paper-input value="{{resource}}"
                                                                             placeholder="Path to resource. This resource will be used for both runtimeMode 'prod' and 'dev'."
                                                                             no-label-float>
                                                                </paper-input>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <paper-icon-item class="addItem"
                                                                     on-tap="addEndpointResource"
                                                                     data-endpoint-id$="[[endpoint.endpointId]]">
                                                        <iron-icon icon="icons:add" item-icon></iron-icon>
                                                        <paper-item-body>
                                                            <div>Add Resource</div>
                                                        </paper-item-body>
                                                    </paper-icon-item>
                                                </div>
                                            </iron-collapse>

                                            <div tabindex="0"
                                                 on-tap="toggleCollapse"
                                                 class="collapse-header"
                                                 data-collapse-id$="[[_idForCollapse(index, 'endpoint_dependencies_')]]">
                                                    <span title="0..n other artifacts-endpoints this artifact-endpoint needs to work properly. Note: 'webpackage': 'this' refers artifact(s) of the this webpackage.">
                                                        Dependencies
                                                    </span>
                                                <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                                            </div>
                                            <iron-collapse id="[[_idForCollapse(index, 'endpoint_dependencies_')]]">
                                                <div class="collapse-content">
                                                    <template is="dom-repeat"
                                                              id="dependencies"
                                                              is="dom-repeat"
                                                              items="{{endpoint.dependencies}}"
                                                              as="dependency">
                                                        <div class="list-item-container">
                                                            <paper-input
                                                                    pattern="^[a-z0-9-@\.]+(-SNAPSHOT)?\/[a-z0-9-]+\/[a-z0-9-]+"
                                                                    no-label-float
                                                                    value="{{dependency}}">
                                                            </paper-input>
                                                        </div>
                                                    </template>
                                                    <paper-icon-item class="addItem"
                                                                     on-tap="addEndpointDependency"
                                                                     data-endpoint-id$="[[endpoint.endpointId]]">
                                                        <iron-icon icon="icons:add" item-icon></iron-icon>
                                                        <paper-item-body>
                                                            <div>Add Dependency</div>
                                                        </paper-item-body>
                                                    </paper-icon-item>
                                                </div>
                                            </iron-collapse>
                                        </div>
                                    </iron-collapse>
                                </div>
                            </template>
                            <paper-icon-item class="addItem" on-tap="addEndpoint">
                                <iron-icon icon="icons:add" item-icon></iron-icon>
                                <paper-item-body>
                                    <div>Add Endpoint</div>
                                </paper-item-body>
                            </paper-icon-item>
                        </div>
                    </iron-collapse>

                    <div tabindex="0"
                         on-tap="toggleCollapse"
                         data-collapse-id="slotsCollapse"
                         class="main-collapse-header collapse-header">
                        <span title="1..n slots to exchange data with other elementaries or compounds.">Slots</span>
                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                    </div>
                    <iron-collapse id="slotsCollapse">
                        <div class="collapse-content">
                            <template is="dom-repeat" id="slots" items="[[artifact.slots]]" as="slot">
                                <div>
                                    <div tabindex="0"
                                         on-tap="toggleCollapse"
                                         class="collapse-header"
                                         data-collapse-id$="[[_idForCollapse(index, 'slot_')]]">
                                        <span>[[slot.slotId]]</span>
                                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                                    </div>
                                    <iron-collapse id$="[[_idForCollapse(index, 'slot_')]]">
                                        <div class="collapse-content">
                                            <paper-input label="Slot Id"
                                                         placeholder="Identifier for this slot item - unique within this component."
                                                         pattern="^[a-z][a-zA-Z0-9-]*"
                                                         required
                                                         value="{{slot.slotId}}">
                                            </paper-input>
                                            <paper-input label="Type" list="slotTypes"
                                                         placeholder="Data type of the slot."
                                                         required
                                                         value="{{slot.type}}">
                                            </paper-input>
                                            <datalist id="slotTypes">
                                                <option value="boolean"></option>
                                                <option value="string"></option>
                                                <option value="number"></option>
                                                <option value="object"></option>
                                                <option value="array"></option>
                                            </datalist>
                                            <paper-textarea label="description"
                                                            placeholder="Description of this slot: responsibility, expected data-structure etc.">
                                            </paper-textarea>
                                            <label title="A slot can be public accessible as input-slot (receive data), output-slot (propagate data) or both. If this attribute not exist, is the slot bidirectional">
                                                Direction
                                            </label>
                                            <paper-checkbox checked="[[_isInputSlot(slot)]]">Input
                                            </paper-checkbox>
                                            <paper-checkbox checked="[[_isOutputSlot(slot)]]">Output
                                            </paper-checkbox>
                                        </div>
                                    </iron-collapse>
                                </div>
                            </template>
                            <paper-icon-item class="addItem" on-tap="addSlot">
                                <iron-icon icon="icons:add" item-icon></iron-icon>
                                <paper-item-body>
                                    <div>Add Slot</div>
                                </paper-item-body>
                            </paper-icon-item>
                        </div>
                    </iron-collapse>

                    <div tabindex="0"
                         on-tap="toggleCollapse"
                         data-collapse-id="membersCollapse"
                         class="main-collapse-header collapse-header">
                        <span title="Referenced components (elementaries or compounds) acting as members of this compound component.">
                            Members
                        </span>
                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                    </div>
                    <iron-collapse id="membersCollapse">
                        <div class="collapse-content">
                            <template is="dom-repeat" id="members" items="[[artifact.members]]" as="member">
                                <div>
                                    <div tabindex="0"
                                         on-tap="toggleCollapse"
                                         class="collapse-header"
                                         data-collapse-id$="[[_idForCollapse(index, 'member_')]]">
                                        <span>[[member.memberId]]</span>
                                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                                    </div>
                                    <iron-collapse id$="[[_idForCollapse(index, 'member_')]]">
                                        <div class="collapse-content">
                                            <paper-input label="Member Id"
                                                         placeholder="Identifier for this member item - unique within this compound component."
                                                         pattern="^[a-z][a-zA-Z0-9-]*"
                                                         required
                                                         value="{{member.memberId}}">
                                            </paper-input>
                                            <paper-input label="Component Id"
                                                         placeholder="Id of the component for this member item (e.g. 'org.example.my-package@1.0/artifact1')"
                                                         pattern="^([a-z0-9]+||([a-z0-9]+[a-z0-9-][a-z0-9]+)*)(\.([a-z0-9]+||([a-z0-9]+[a-z0-9-][a-z0-9]+)*))*[@](\d+)(\.[\d]+)*(-SNAPSHOT)?||(this)/([a-z0-9-]+)"
                                                         required
                                                         value="{{member.componentId}}">
                                            </paper-input>
                                            <paper-textarea label="Description"
                                                            placeholder="Description of this member: responsibility, usage notes etc."
                                                            value="{{member.description}}">
                                            </paper-textarea>
                                            <paper-input label="DisplayName"
                                                         placeholder="Display name of the referenced member for design view of the BDE"
                                                         value="{{member.displayName}}">
                                            </paper-input>
                                        </div>
                                    </iron-collapse>
                                </div>
                            </template>
                            <paper-icon-item class="addItem" on-tap="addMember">
                                <iron-icon icon="icons:add" item-icon></iron-icon>
                                <paper-item-body>
                                    <div>Add Member</div>
                                </paper-item-body>
                            </paper-icon-item>
                        </div>
                    </iron-collapse>

                    <div tabindex="0"
                         on-tap="toggleCollapse"
                         data-collapse-id="connectionsCollapse"
                         class="main-collapse-header collapse-header">
                        <span title="List of designed connection between the members and between members and this compound component.">
                            Connections
                        </span>
                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                    </div>
                    <iron-collapse id="connectionsCollapse">
                        <div class="collapse-content">
                            <template is="dom-repeat" id="connections" items="[[artifact.connections]]" as="connection">
                                <div>
                                    <div tabindex="0" on-tap="toggleCollapse" class="collapse-header"
                                         data-collapse-id$="[[_idForCollapse(index, 'connection_')]]">
                                        <span>[[connection.connectionId]]</span>
                                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                                    </div>
                                    <iron-collapse id$="[[_idForCollapse(index, 'connection_')]]">
                                        <div class="collapse-content">
                                            <paper-input label="Connection Id"
                                                         placeholder="Identifier for this connection item - unique within this compound component."
                                                         pattern="^[a-z][a-zA-Z0-9-:]*"
                                                         required
                                                         value="{{connection.connectionId}}">
                                            </paper-input>
                                            <paper-textarea label="Description"
                                                            placeholder="A short description of this connection: responsibility etc."
                                                            value="{{connection.description}}">
                                            </paper-textarea>
                                            <paper-textarea label="Hook Function"
                                                            placeholder="A function declaration as a string or a global function name. This function will called, before a connection destination model variable setted."
                                                            value="{{connection.hookFunction}}">
                                            </paper-textarea>
                                            <paper-checkbox
                                                    title="If repeatedValues is true, the same value consecutively will propagated, otherwise not. The default value is false."
                                                    checked="{{connection.repeatedValues}}">
                                                Repeated Values
                                            </paper-checkbox>
                                            <paper-checkbox
                                                    title="Indicate to copy or not to copy the payload (inc case the payload is an object). true: make a copy, false: do not make a copy - pass by reference. (default == true)"
                                                    checked="{{connection.copyValue}}">
                                                Copy Value
                                            </paper-checkbox>
                                            <div class="list-item-container">
                                                <strong>Source</strong>
                                                <paper-input label="Member Id Reference"
                                                             placeholder="The 'memberId' value of the member item, the slot belongs to. If the memberIdRef property is missed, it will connected with an own slot of the compound component."
                                                             pattern="^[a-z][a-zA-Z0-9-]*"
                                                             value="{{connection.source.memberIdRef}}">
                                                </paper-input>
                                                <paper-input label="Slot"
                                                             placeholder="The name of the slot."
                                                             required
                                                             value="{{connection.source.slot}}">
                                                </paper-input>
                                                <strong>Destination</strong>
                                                <paper-input label="Member Id Reference"
                                                             placeholder="The 'memberId' value of the member item, the slot belongs to. If the memberIdRef property is missed, it will connected with an own slot of the compound component."
                                                             pattern="^[a-z][a-zA-Z0-9-]*"
                                                             value="{{connection.destination.memberIdRef}}">
                                                </paper-input>
                                                <paper-input label="Slot"
                                                             placeholder="The name of the slot."
                                                             required
                                                             value="{{connection.destination.slot}}">
                                                </paper-input>
                                            </div>
                                        </div>
                                    </iron-collapse>
                                </div>
                            </template>
                            <paper-icon-item class="addItem" on-tap="addConnection">
                                <iron-icon icon="icons:add" item-icon></iron-icon>
                                <paper-item-body>
                                    <div>Add Connection</div>
                                </paper-item-body>
                            </paper-icon-item>
                        </div>
                    </iron-collapse>

                    <div tabindex="0"
                         on-tap="toggleCollapse"
                         data-collapse-id="initsCollapse"
                         class="main-collapse-header collapse-header">
                        <span title="List of slot initializations of the compound and member component(s).">Inits</span>
                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                    </div>
                    <iron-collapse id="initsCollapse">
                        <div class="collapse-content">
                            <template is="dom-repeat" id="inits" items="[[artifact.inits]]" as="init">
                                <div>
                                    <div tabindex="0" on-tap="toggleCollapse" class="collapse-header"
                                         data-collapse-id$="[[_idForCollapse(index, 'init_')]]">
                                        <span>[[index]]</span>
                                        <iron-icon icon="[[_calculateToggleIcon()]]"></iron-icon>
                                    </div>
                                    <iron-collapse id$="[[_idForCollapse(index, 'init_')]]">
                                        <div class="collapse-content">
                                            <paper-input label="Member Id Reference"
                                                         placeholder="The 'memberId' value of the member item, the slot belongs to. If the property is missed, it refers to an own slot of the compound component."
                                                         pattern="^[a-z][a-zA-Z0-9-]*"
                                                         value="{{init.memberIdRef}}">
                                            </paper-input>
                                            <paper-input label="Slot"
                                                         placeholder="Name of the slot to be initialized."
                                                         required
                                                         value="{{init.slot}}">
                                            </paper-input>
                                            <paper-textarea label="Value"
                                                            placeholder="The value to init the slot with."
                                                            value="{{init.value}}">
                                            </paper-textarea>
                                            <paper-textarea label="Description"
                                                            placeholder="A short description of this init item: responsibility etc."
                                                            value="{{init.description}}">
                                            </paper-textarea>
                                        </div>
                                    </iron-collapse>
                                </div>
                            </template>
                            <paper-icon-item class="addItem" on-tap="addInit">
                                <iron-icon icon="icons:add" item-icon></iron-icon>
                                <paper-item-body>
                                    <div>Add Init</div>
                                </paper-item-body>
                            </paper-icon-item>
                        </div>
                    </iron-collapse>
                </template>

                <template is="dom-if" if="[[_artifactIsElementary(artifact)]]">

                </template>

                <template is="dom-if" if="[[_artifactIsUtility(artifact)]]">

                </template>

                <template is="dom-if" if="[[_artifactIsApp(artifact)]]">

                </template>
            </paper-dialog-scrollable>

            <div class="buttons">
                <paper-button raised dialog-dismiss>Close</paper-button>
            </div>

        </paper-dialog>


    </template>
    <script>
        Polymer({
            is: 'bde-explorer-details',
            properties: {

                artifact: {
                    type: Object,
                    notify: true
                },

                opened: {
                    type: Boolean,
                    value: false
                }
            },

            open: function () {
                this.opened = true;
            },

            close: function () {
                this.opened = false;
            },

            toggleCollapse: function (e) {
                var collapseDiv = this.$$('#' + e.currentTarget.dataset.collapseId);
                collapseDiv.toggle();
                Polymer.dom(e.currentTarget).querySelector('iron-icon').icon = this._calculateToggleIcon(collapseDiv.opened);
            },

            _artifactIsApp: function (artifact) {
                return artifact.artifactType == 'appComponent';
            },

            _artifactIsCompound: function (artifact) {
                return artifact.artifactType == 'compoundComponent';
            },

            _artifactIsElementary: function (artifact) {
                return artifact.artifactType == 'elementaryComponent';
            },

            _artifactIsUtility: function (artifact) {
                return artifact.artifactType == 'utilityComponent';
            },

            _idForCollapse: function (index, prefix) {
                prefix = prefix || ''
                return prefix + 'collapse' + index;
            },

            _calculateToggleIcon: function (state) {
                return state ? 'icons:arrow-drop-up' : 'icons:arrow-drop-down';
            },

            _isObject: function (value) {
                return typeof value === 'object';
            },
            _isInputSlot: function (slot) {
                for (var i = 0; i < slot.direction.length; i++) {
                    if (slot.direction[i] === 'input') {
                        return true;
                    }
                }
                return false;
            },
            _isOutputSlot: function (slot) {
                for (var i = 0; i < slot.direction.length; i++) {
                    if (slot.direction[i] === 'output') {
                        return true;
                    }
                }
                return false;
            },
            addRunnable: function () {
                this.push('artifact.runnables', {name: 'newRunnable', path: '', description: ''});
            },
            addEndpoint: function () {
                this.push(
                        'artifact.endpoints',
                        {endpointId: 'newEndpoint', description: '', resources: [{prod: '', dev: ''}], dependencies: []}
                );
            },
            addEndpointResource: function (e) {
                var endpointId = e.currentTarget.dataset.endpointId;
                var i = this.indexOfItemByProperty(this.artifact.endpoints, 'endpointId', endpointId);
                this.push('artifact.endpoints.' + i + '.resources', {prod: '', dev: ''});
            },
            addEndpointDependency: function (e) {
                var endpointId = e.currentTarget.dataset.endpointId;
                var i = this.indexOfItemByProperty(this.artifact.endpoints, 'endpointId', endpointId);
                this.push('artifact.endpoints.' + i + '.dependencies', '');
            },
            indexOfItemByProperty: function (list, property, value) {
                for (var i = 0; i < list.length; i++) {
                    if (list[i][property] === value) {
                        return i;
                    }
                }
                return -1;
            },
            addSlot: function () {
                this.push('artifact.slots', {slotId: 'newSlot', type: '', direction: [], description: ''});
            },
            addMember: function () {
                this.push('artifact.members', {
                    memberId: 'newMember',
                    componentId: '',
                    displayName: '',
                    description: ''
                });
            },
            addConnection: function () {
                this.push(
                        'artifact.connections',
                        {
                            connectionId: 'newConnection',
                            source: {memberIdRef: '', slot: ''},
                            destination: {memberIdRef: '', slot: ''},
                            copyValue: false,
                            repeatedValues: false,
                            hookFunction: '',
                            description: ''
                        }
                );
            },
            addInit: function () {
                this.push('artifact.inits', {memberIdRef: '', slot: '', value: '', description: ''});
            }
        });
    </script>
</dom-module>
