<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/iron-collapse/iron-collapse.html">
<link rel="import" href="../../vendor/iron-icons/iron-icons.html">
<link rel="import" href="../../vendor/paper-item/paper-icon-item.html">
<link rel="import" href="../../vendor/paper-item/paper-item-body.html">
<link rel="import" href="../../vendor/paper-button/paper-button.html">
<link rel="import" href="../../vendor/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../vendor/paper-badge/paper-badge.html">
<link rel="import" href="../../vendor/paper-dialog/paper-dialog.html">
<link rel="import" href="../../vendor/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../vendor/paper-input/paper-input.html">
<link rel="import" href="../../vendor/paper-input/paper-textarea.html">
<link rel="import" href="../../vendor/paper-styles/default-theme.html">
<link rel="import" href="bde-compound-creator.html">
<link rel="import" href="bde-explorer-details.html" />
<link rel="import" href="../../vendor/paper-menu/paper-menu.html"/>
<link rel="import" href="../../vendor/paper-menu/paper-submenu.html"/><!--
`bde-explorer` is the management component for handling cubble packages

Example:

    <bde-explorer></bde-explorer>

-->
<dom-module id="bde-explorer">
    <template>
        <style is="custom-style">
            :host {
                display: block;
                --explorer-background-color: #f5f5f5;
            }

            .container {
                margin-top: 15px;
                cursor: pointer;
            }

            .container:focus {
                outline: 0;
            }

            .container > span {
                color: var(--bde-explorer-heading-text-color, --primary-text-color);

                @apply(--paper-font-body2);
            }

            .container > .count {
                color: var(--secondary-text-color);

                @apply(--paper-font-caption);
            }

            .addItem {
                cursor: pointer;
            }

            paper-button {
                width: 90%;
                margin: 2em 5% 0;
                background-color: var(--primary-background-color);
            }

            .endpoint-item {
                padding-left: 50px;
                min-height: 0!important;
            }

            .endpoint-list-header {
                padding-left: 30px;
                font-weight: 500;
            }

            paper-menu {
                background-color: var(--explorer-background-color);
            }


        </style>

        <h2>Webpackage Explorer</h2>

        <bde-compound-creator id="compoundCreator"
                              on-last-artifact-changed="handleNewCompound"></bde-compound-creator>
        <bde-explorer-details id="explorerDetails"
                              artifact="{{selectedCompound}}"></bde-explorer-details>

        <div class="container" tabindex="0" on-tap="toggleApps">
            <iron-icon icon="[[_calculateToggleIcon(_appsOpen)]]"></iron-icon>
            <span>Applications</span>
            <span class="count">([[manifest.artifacts.apps.length]])</span>
        </div>

        <iron-collapse id="collapseApps" opened="[[_appsOpen]]">
            <template is="dom-repeat" id="appList"
                      items="{{manifest.artifacts.apps}}" as="app">
                <paper-item on-tap="selectApp" toggles disabled>
                    <paper-item-body two-line>
                        <div>[[app.artifactId]]</div>
                        <div secondary>[[app.description]]</div>
                    </paper-item-body>
                    <!--<paper-icon-button icon="icons:settings" alt="Settings" on-tap="openSettings">-->
                    </paper-icon-button>
                </paper-item>
            </template>

            <!--<paper-icon-item class="addItem" on-tap="addApp">-->
            <!--<iron-icon icon="icons:add" item-icon></iron-icon>-->
            <!--<paper-item-body>-->
            <!--<div>Add Application</div>-->
            <!--</paper-item-body>-->
            <!--</paper-icon-item>-->

            <array-selector id="appSelector"
                            items="{{manifest.artifacts.apps}}"
                            selected="{{selectedApp}}">
            </array-selector>
        </iron-collapse>

        <div class="container" tabindex="0" on-tap="toggleCompounds">
            <iron-icon icon="[[_calculateToggleIcon(_compoundsOpen)]]"></iron-icon>
            <span>Compounds</span>
            <span class="count">([[manifest.artifacts.compoundComponents.length]])</span>
        </div>

        <iron-collapse id="collapseCompounds" opened="[[_compoundsOpen]]">
            <paper-menu attr-for-selected="data-artifact-id" on-iron-select="explorerItemSelected"
                        selected="[[selectedCompound.artifactId]]"
                        id="compoundSelector">
                <template is="dom-repeat" id="compoundList"
                          items="{{manifest.artifacts.compoundComponents}}" as="compound">
                    <paper-submenu data-artifact-id$="[[compound.artifactId]]">
                        <!--<paper-icon-item class="menu-trigger">-->
                        <paper-item class="menu-trigger" title="[[compound.artifactId]]">
                            <!--<iron-icon icon="icons:donut-small" item-icon></iron-icon>-->
                            <paper-item-body three-line>
                                <div>[[compound.artifactId]]</div>
                                <div secondary>[[compound.description]]</div>
                                <div secondary>[[compound.members.length]] Members</div>
                            </paper-item-body>
                            <paper-icon-button icon="icons:settings" alt="Settings" on-tap="openCompoundDetails">
                            </paper-icon-button>
                        </paper-item>
                        <paper-menu attr-for-selected="data-endpoint-id" class="menu-content sublist" on-iron-select="explorerItemSelected">
                            <div class="endpoint-list-header">Endpoints</div>
                            <template is="dom-repeat" items="[[compound.endpoints]]" as="endpoint">
                                <paper-item data-endpoint-id$="[[endpoint.endpointId]]"
                                                 class="endpoint-item" title="[[endpoint.endpointId]]">
                                    <paper-item-body>
                                        <div data-endpoint-id$="[[endpoint.endpointId]]">[[endpoint.endpointId]]</div>
                                        <div secondary>[[endpoint.description]]</div>
                                    </paper-item-body>
                                </paper-item>
                            </template>
                        </paper-menu>
                    </paper-submenu>
                </template>
            </paper-menu>

            <paper-icon-item class="addItem" on-tap="addCompound">
                <iron-icon icon="icons:add" item-icon></iron-icon>
                <paper-item-body>
                    <div>Add Compound Cubble</div>
                </paper-item-body>
            </paper-icon-item>
        </iron-collapse>

        <div class="container" tabindex="0" on-tap="toggleElementaries">
            <iron-icon icon="[[_calculateToggleIcon(_elementariesOpen)]]"></iron-icon>
            <span>Elementaries</span>
            <span class="count">([[manifest.artifacts.elementaryComponents.length]])</span>
        </div>

        <iron-collapse id="collapseElementaries" opened="[[_elementariesOpen]]">
            <template is="dom-repeat" id="elementaryList"
                      items="{{manifest.artifacts.elementaryComponents}}" as="elementary">
                <paper-item on-tap="selectElementary" toggles disabled>
                    <paper-item-body two-line>
                        <div>[[elementary.artifactId]]</div>
                        <div secondary>[[elementary.description]]</div>
                    </paper-item-body>
                    <!--<paper-icon-button icon="icons:settings" alt="Settings" on-tap="openSettings"></paper-icon-button>-->
                </paper-item>
            </template>

            <!--<paper-icon-item class="addItem" on-tap="addElementary">-->
            <!--<iron-icon icon="icons:add" item-icon></iron-icon>-->
            <!--<paper-item-body>-->
            <!--<div>Add Elementary Cubble</div>-->
            <!--</paper-item-body>-->
            <!--</paper-icon-item>-->

            <array-selector id="elementarySelector"
                            items="{{manifest.artifacts.elementaryComponents}}"
                            selected="{{selectedElementary}}">
            </array-selector>
        </iron-collapse>

        <div class="container" tabindex="0" on-tap="toggleUtilities">
            <iron-icon icon="[[_calculateToggleIcon(_utilitiesOpen)]]"></iron-icon>
            <span>Utilities</span>
            <span class="count">([[manifest.artifacts.utilities.length]])</span>
        </div>

        <iron-collapse id="collapseUtilities" opened="[[_utilitiesOpen]]">
            <template is="dom-repeat" id="utilityList"
                      items="{{manifest.artifacts.utilities}}" as="utility">
                <paper-item on-tap="selectUtility" toggles disabled>
                    <paper-item-body two-line>
                        <div>[[utility.artifactId]]</div>
                        <div secondary>[[utility.description]]</div>
                    </paper-item-body>
                    <!--<paper-icon-button icon="icons:settings" alt="Settings" on-tap="openSettings"></paper-icon-button>-->
                </paper-item>
            </template>

            <!--<paper-icon-item class="addItem" on-tap="addUtility">-->
            <!--<iron-icon icon="icons:add" item-icon></iron-icon>-->
            <!--<paper-item-body>-->
            <!--<div>Add Utility</div>-->
            <!--</paper-item-body>-->
            <!--</paper-icon-item>-->

            <array-selector id="utilitySelector"
                            items="{{manifest.artifacts.utilities}}"
                            selected="{{selectedUtility}}">
            </array-selector>
        </iron-collapse>
    </template>
    <script>
        Polymer({
            is: 'bde-explorer',

            properties: {

                manifest: {
                    type: Object,
                    observer: 'manifestChanged'
                },
                currentComponentMetadata: {
                    type: Object,
//                    value: function() {
//                        return {
//                            endpointId: null,
//                            artifactId: null,
//                            manifest: null
//                        }
//                    },
                    notify: true
                },

                selectedApp: {
                    type: Object,
                    notify: true
                },

                selectedCompound: {
                    type: Object,
                    notify: true
                },

                selectedElementary: {
                    type: Object,
                    notify: true
                },

                selectedUtility: {
                    type: Object,
                    notify: true
                },

                toggleMenus: {
                    type: Boolean,
                    value: true
                },

                _appsOpen: {
                    type: Boolean,
                    value: false
                },

                _compoundsOpen: {
                    type: Boolean,
                    value: true
                },

                _elementariesOpen: {
                    type: Boolean,
                    value: false
                },

                _utilitiesOpen: {
                    type: Boolean,
                    value: false
                }

            },

            addApp: function () {
                // this.$.addAppDialog.open();
            },

            openCompoundDetails: function (e) {
                e.stopPropagation();
              this.$.explorerDetails.open();
            },

            addCompound: function () {
                this.$.compoundCreator.open();
                // this.$.addCompoundDialog.open();
                // console.dir(this.$.addCompoundForm[0]);
                // this.$.addCompoundForm[0].focus();
            },
            manifestChanged: function () {
                this.deselect();

                if (this.manifest) {
                    this.set('currentComponentMetadata.manifest', this.manifest);
                    this.set('currentComponentMetadata.artifactId', null);
                    this.set('currentComponentMetadata.endpointId', null);
                    var menu = this.$$('#compoundSelector');
                    Polymer.dom(menu).querySelectorAll('paper-submenu').forEach(function (subMenu) {
                        subMenu.close();
                    });
                }
            },
            deselect: function () {
                this.$.appSelector.deselect();
                this.$.utilitySelector.deselect();
                // this.$.compoundSelector.deselect();
                // this.$.utilitySelector.deselect();
            },

//            handleAddCompoundDialogClosed: function (e, reason) {
//                // User clicked outside the dialog
//                if (!reason.canceled && !reason.confirmed) {
//                    this.$.addCompoundForm.reset();
//                }
//            },
//
//            handleAddCompoundFormSubmit: function (e) {
//                if (this.$.addCompoundForm.validate()) {
//                    this.push('artifacts.compounds', this.$.addCompoundForm.serialize());
//                    this.$.addCompoundForm.reset();
//                    this.$.addCompoundDialog.close();
//                }
//            },

            handleNewCompound: function (e) {
                this.push('manifest.artifacts.compoundComponents', e.detail.value);
                this.$.compoundSelector.select(e.detail.value);
            },

            openSettings: function (e) {
                e.stopPropagation();
                var item = e.model.dataHost.itemForElement(e.target);
                item.is = e.model.dataHost.id.replace(/List/, '');

                this.fire('bde-explorer-open-settings', { item: item });
            },

            selectApp: function (e) {
                this.deselect();

                var item = this.$.appList.itemForElement(e.target);
                item.is = 'app';
                this.$.appSelector.select(item);

                this.fire('iron-select', { is: 'app', item: item });
            },

            explorerItemSelected: function (e) {
                var item = e.detail.item;

                if (item.dataset.artifactId && item.dataset.artifactId !== this.currentComponentMetadata.artifactId) {
                    this.deselectCompound();
                    this.selectCompound(item);
                } else if (item.dataset.endpointId && item.dataset.endpointId !== this.currentComponentMetadata.endpointId) {
                    this.selectEndpoint(item);
                }

            },

            deselectCompound: function () {
                var menu = this.$$('#compoundSelector');
                menu.selected  = null;
                Polymer.dom(menu).querySelectorAll('paper-submenu').forEach(function (subMenu) {
                    subMenu.close();
                    Polymer.dom(subMenu).querySelector('paper-menu').selected = null;
                });

            },

            selectCompound: function (item) {
                item.is = 'compound';
                this.set('currentComponentMetadata.artifactId', item.dataset.artifactId);
                var subMenu =  this.$$('[data-artifact-id=' + item.dataset.artifactId + ']');
                subMenu.open();
                Polymer.dom(subMenu).querySelector('paper-menu').select(Polymer.dom(subMenu).querySelector('[data-endpoint-id]').dataset.endpointId);
                var compound;
                this.manifest.artifacts.compoundComponents.forEach(function(comp){
                   if(comp.artifactId === item.dataset.artifactId){
                       compound = comp;
                   }
                });
                this.set('selectedCompound', compound);
            },
            selectEndpoint: function (item) {
                this.set('currentComponentMetadata.endpointId', item.dataset.endpointId);
            },

            selectElementary: function (e) {
                this.deselect();

                var item = this.$.elementaryList.itemForElement(e.target);
                item.is = 'elementary';
                this.$.elementarySelector.select(item);

                this.fire('iron-select', { is: 'elementary', item: item });
            },

            selectUtility: function (e) {
                this.deselect();

                var item = this.$.utilityList.itemForElement(e.target);
                item.is = 'utility';
                this.$.elementarySelector.select(item);

                this.fire('iron-select', { is: 'utility', item: item });
            },

            toggleApps: function () {
                if (this.toggleMenus) {
                    this._compoundsOpen = false;
                    this._elementariesOpen = false;
                    this._utilitiesOpen = false;
                }
                this._appsOpen = !this._appsOpen;
            },

            toggleCompounds: function () {
                if (this.toggleMenus) {
                    this._appsOpen = false;
                    this._elementariesOpen = false;
                    this._utilitiesOpen = false;
                }
                this._compoundsOpen = !this._compoundsOpen;
            },

            toggleElementaries: function () {
                if (this.toggleMenus) {
                    this._appsOpen = false;
                    this._compoundsOpen = false;
                    this._utilitiesOpen = false;
                }
                this._elementariesOpen = !this._elementariesOpen;
            },

            toggleUtilities: function () {
                if (this.toggleMenus) {
                    this._appsOpen = false;
                    this._compoundsOpen = false;
                    this._elementariesOpen = false;
                }
                this._utilitiesOpen = !this._utilitiesOpen;
            },

            _calculateToggleIcon: function (state) {
                return state ? 'icons:arrow-drop-up' : 'icons:arrow-drop-down';
            },

            _equals: function (a, b) {
                return a === b;
            }
        });
    </script>
</dom-module>
