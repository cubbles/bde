<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/iron-ajax/iron-ajax.html">
<link rel="import" href="../../vendor/iron-list/iron-list.html">
<link rel="import" href="../../vendor/iron-icons/iron-icons.html">
<link rel="import" href="../../vendor/paper-input/paper-input.html">
<link rel="import" href="../../vendor/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../app-data/app-data.html">
<link rel="import" href="bde-base-item.html">
<!--
A BDE custom element, which gets the 'Cubbles-Components' from the Base via AJAX.
The response is a list of items with the description attribute on display.

The list is rendered by repeating the bde-base-item.

Example:

    <bde-base-browser
        selected="{{selected}}"
        compounds-only>
    </bde-base-browser>

@group BDE Custom Elements
@element bde-base-browser
@demo ../elements/bde-base-browser/demo/index.html
-->
<dom-module id="bde-base-browser">
    <template>
        <style is="custon-style">
        :host {
            display: block;
        }

        #clearBtn {
            color: var(--paper-grey-600);
            width: 23px; /* 15px + 2*4px for padding */
            height: 23px;
            padding: 0px 4px;
        }

        iron-list {
            @apply(--layout-flex);
        }
        </style>

        <app-data key="settings" data="{{_settings}}"></app-data>

        <iron-ajax id="ajax"
            url="[[_computeBaseUrl(_settings.baseUrl, _settings.baseName)]]"
            handle-as="json"
            on-response="handleResponse"
            auto></iron-ajax>

        <paper-input id="search"
            label="Search components in the base..."
            value="{{searchTerm}}"
            on-input="handleInput"
            autofocus>
            <iron-icon icon="icons:search" prefix></iron-icon>
            <paper-icon-button id="clearBtn"
                icon="icons:clear"
                title="clear search"
                on-tap="clearInput"
                suffix>
            </paper-icon-button>
        </paper-input>

        <iron-list id="list"
            items="[[_filtered]]"
            multi-selection>
            <template>
                <bde-base-item item="{{item}}"></bde-base-item>
            </template>
        </iron-list>

    </template>
    <script>
    Polymer({
        is: 'bde-base-browser',

        properties: {

            /**
             * The search term from the `paper-input` field.
             *
             * @type {String}
             */
            searchTerm: {
                type: String,
                notify: true
            },

            /**
             * The selected artifact
             *
             * @type {Object}
             */
            selected: {
                type: Object,
                notify: true
            },

            /**
             * Wether to display only app artifacts
             *
             * @type {Boolean}
             */
            appsOnly: {
                type: Boolean,
                value: false
            },

            /**
             * Wether to display only elementary artifacts
             *
             * @type {Boolean}
             */
            elementariesOnly: {
                type: Boolean,
                value: false
            },

            /**
             * Wether to display only compound artifacts
             *
             * @type {Boolean}
             */
            compoundsOnly: {
                type: Boolean,
                value: false
            },

            /**
             * Wether to display only utility artifacts
             *
             * @type {Boolean}
             */
            utilitiesOnly: {
                type: Boolean,
                value: false
            },

            /**
             * All cubbles in the base
             *
             * @type {Array}
             * @private
             */
            _cubbles: {
                type: Array
            },

            /**
             * Cubbles filtered by the criteria
             *
             * @type {Array}
             * @private
             */
            _filtered: {
                type: Array
            },

            /**
             * Global app settings
             *
             * @type {Object}
             * @private
             */
            _settings: {
                type: Object
            }
        },

        listeners: {
            'iron-select': 'handleItemSelect'
        },

        /**
         * Clear the input of the search field on button click.
         *
         * @method clearInput
         */
        clearInput: function() {
            this.set('_filtered', []);
            this.$.search.value = '';
            this.$.search.focus();
        },

        /**
         * Handles the input of a search term in the input field
         * and returns the filtered array matching the expression in the input.
         * As well as resizing the dialog, based on search result.
         *
         * @method handleInput
         */
        handleInput: function(event) {
            this.debounce('handleInput', function() {
                var searchTerm = event.target.value.replace(/[*,?]/g, '');
                var filtered = JSON.parse(JSON.stringify(this._cubbles || []));

                // Scroll to top of the list
                this.$.list.scrollTarget.scrollTop = 0;

                if (searchTerm.length === 0) {
                    this.set('_filtered', []);
                    return;
                }

                if (this.appsOnly) {
                  filtered = filtered.filter( i => i.artifactType == "app");
                }

                if (this.elementariesOnly) {
                  filtered = filtered.filter( i => i.artifactType == "elementaryComponent");
                }

                if (this.compoundsOnly) {
                  filtered = filtered.filter( i => i.artifactType == "compoundComponent");
                }

                if (this.utilitiesOnly) {
                  filtered = filtered.filter( i => i.artifactType == "utility");
                }

                filtered = filtered.filter(i => -1 != i.artifactId.indexOf(searchTerm) ||
                                                -1 != i.name.indexOf(searchTerm));

                filtered = filtered.sort((a,b) => (a.artifactId == b.artifactId) ? 0 : (a.artifactId < b.artifactId) ? -1 : 1)

                this.set('_filtered', filtered);

                this.async(() => this.$.list.fire('iron-resize'));
            }.bind(this), 125);
        },

        handleItemSelect: function(event) {
            this.selected = event.detail;
            this.fire('iron-selected', {item: this.selected});
        },

        /**
         * Handles the initial AJAX response and applies a prefiltering of the result list.
         *
         * @method handleResponse
         * @param  {[Event]} event [Response of AJAX call.]
         */
        // TODO (ene): use couchDB functionality for filtering certain document-attributes, like modelVersion...
        handleResponse: function() {
            var cubbles = this.$.ajax.lastResponse
                .filter(item => item.modelVersion.match(/8.3/))
                .filter(item => item.artifactType == 'compoundComponent' ||
                        item.artifactType == 'elementaryComponent');

            this.set('_cubbles', cubbles);
        },

        _computeBaseUrl: function(baseUrl, baseName) {
            return baseUrl.replace(/[/]?$/, '/') + baseName + '/_design/couchapp-artifactsearch/_list/listArtifacts/viewArtifacts';
        }
    });
    </script>
</dom-module>
