<!-- libraries -->
<link rel="import" href="../../vendor/polymer/polymer.html">

<!-- paper elements-->
<link rel="import" href="../../vendor/paper-toast/paper-toast.html">
<link rel="import" href="../../vendor/paper-button/paper-button.html">

<!-- iron elements -->

<!--
DESCRIPTION

A BDE custom element, creating and providing a vald Cubble webpackage manifest for the BDE application.
It is especially used to provide the created manifest to the application view.

Example:

    <bde-webpackdoc-creator id="creator"
        type="[[type]]"
        slots="[[_concatArray(inslots, outslots)]]"
        members="[[members]]"
        connections="[[connections]]"
        initializers="[[initializers]]"
        manifest="{{manifest}}"
        general-data="[[generalData]]"
        manifest-complete="{{manifestComplete}}">
    </bde-webpackdoc-creator>

@group BDE Custom Elements
@element bde-webpackdoc-creator
-->

<dom-module id="bde-webpackdoc-creator">

    <style>
    :host {
        display: block;
    }
    </style>

    <template>

        <paper-toast id="noProjPropToast" text="Incomplete Manifest" duration="5000">
            <paper-button on-tap="openProjectProperties">Edit Project Properties</paper-button>
        </paper-toast>

        <paper-toast id="noMembersToast" text="No Cubbles added" duration="5000"></paper-toast>

    </template>

    <script>

        Polymer({

            is: 'bde-webpackdoc-creator',

            properties: {

                /**
                 * External slots of the given Cubble compound component.
                 * @type {Array}
                 * @property slots
                 */
                slots: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Members of the given Cubble compound component.
                 * @type {Array}
                 * @property members
                 */
                members: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Connections of the given Cubble compound component.
                 * @type {Array}
                 * @property connections
                 */
                connections: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Initializers of the given Cubble compound component.
                 * @type {Array}
                 * @property initializers
                 */
                initializers: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Boolean state for the completion of the manifest. If there are no members set the state is false.
                 * @type {Boolean}
                 * @property manifestComplete
                 */
                manifestComplete: {
                    type: Boolean,
                    value: false,
                    notify: true
                },

                /**
                 * Databound property for the applicationwide settings.
                 * @type {Object}
                 * @property generalData
                 */
                generalData: {
                    type: Object,
                    notify: true,
                    observer: '_buildManifest'
                },

                /**
                 * Connections to be set on the manifest property to be pushed to the application view.
                 * @type {Object}
                 * @property artifactConnections
                 */
                artifactConnections: {
                    type: Object,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Members to be set on the manifest property to be pushed to the application view.
                 * @type {Object}
                 * @property artifactMembers
                 */
                artifactMembers: {
                    type: Object,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Slots to be set on the manifest property to be pushed to the application view.
                 * @type {Object}
                 * @property artifactSlots
                 */
                artifactSlots: {
                    type: Object,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Initializers to be set on the manifest property to be pushed to the application view.
                 * @type {Object}
                 * @property artifactInits
                 */
                artifactInits: {
                    type: Object,
                    value: function () {
                        return [];
                    }
                },

                /**
                 * Endpoints for the artifact, usually an URL for a base-resource.
                 * @type {Array}
                 * @property artifactEndpoints
                 */
                artifactEndpoints: {
                    type: Array,
                    value: function () {
                      return[];
                    }
                },

                /**
                 * [dependency description ??? ]
                 * @type {[type]}
                 * @property dependency
                 */
                dependency: Object,

                /**
                 * The complete Cubbles manifest, to be bound to the application view.
                 * @type {Object}
                 * @property manifest
                 */
                manifest: {
                    type: Object,
                    notify: true,
                    value: function () {
                        return {};
                    },
                    observer: 'manifestChanged'
                }
            },

            observers: [
                'connectionsChanged(connections.*)',
                'initializersChanged(initializers.*)',
                'membersChanged(members.*)',
                'slotsChanged(slots.*)',
                '_buildManifest(manifestComponent.*)'
            ],

            // TODO(fdu): Slot direction not honored
            //            Slots not added to manifest
            /**
             * Observer for slot changes.
             * @return {[Object]} Changed slot
             * @method slotsChanged
             */
            slotsChanged: function () {
                this.set('artifactSlots', this.slots.map(s => {
                    return {
                        name: s.originalName,
                        type: s.type,
                        direction: ['input']
                    };
                }));

            },

            /**
             * Observer for member changes.
             * @method membersChanged
             */
            membersChanged: function () {

                var dependencies = [];
                this.artifactEndpoints = [];

                // Extract Initializers
                this.set('initializers', []);
                this.members.forEach((member, memberIndex) => {
                    member.inslots
                        .filter(slot => slot.value)
                        .forEach(slot => {

                            switch (slot.type) {

                                case 'number':
                                    slot.value = +slot.value;
                                break;

                                default:
                                break;
                            }

                            this.push('initializers', {
                                'member': 'm' + memberIndex,
                                'slot': slot.originalId,
                                'value': slot.value
                            });
                        });

                        // add endpoint of each member to the dependencies of the whole artifact
                        var endpoint = member.metadata.endpoints.find(e => e.endpoindId == 'main') || member.metadata.endpoints[0].endpointId;
                        endpoint = member.metadata.webpackageId + '/' + member.compoundId + '/' + endpoint;
                        if(!dependencies.find(e => e == endpoint)){
                          dependencies.push(endpoint);
                        }

                });

                this.set('artifactMembers', this.members
                    .map( (member, memberIndex) => {
                        return {
                            id: 'm' + memberIndex,
                            componentId: member.metadata.webpackageId + '/' + member.compoundId
                        };
                    }
                ));

                var endpoint = {
                  endpointId: 'main',
                  resources: [],
                  dependencies: dependencies
                };

                this.artifactEndpoints.push(endpoint);

            },

            /**
             * Observer for connection changes.
             * @return {[Object]} Changed connection
             * @method connectionsChanged
             */
            connectionsChanged: function () {
                this.set('artifactConnections', this.connections.map((c,i) => {
                    var sourceMember = this.members.findIndex(m => c.source.memberIndex == m.id);
                    var targetMember = this.members.findIndex(m => c.target.memberIndex == m.id);
                    return {
                        'connectionId': 'con' + i,
                        'source': {
                            'memberIdRef': 'm' + sourceMember,
                            'slot': this.members[sourceMember].outslots.find( s => s.slotId == c.source.slot).originalId
                        },
                        'destination': {
                            'memberIdRef': 'm' + targetMember,
                            'slot': this.members[targetMember].inslots.find( s => s.slotId == c.target.slot).originalId
                        }
                    };
                }));

            },

            /**
             * Observer for Initializers.
             * @return {[Object]} Sets artifactInits
             * @method initializersChanged
             */
            initializersChanged: function () {

                this.set('artifactInits', this.initializers);

            },

            /**
             * Observer for manifest changes. Fires a ready event with the manifest as payload.
             * @method manifestChanged
             */
            manifestChanged: function () {
                this.fire('manifest-ready', { manifest: this.manifest });
            },

            /**
             * Opens the project properties to set the necessary data.
             * @method openProjectProperties
             */
            openProjectProperties: function () {
                document.querySelector('bde-application-settings').open = !document.querySelector('bde-application-settings').open;
            },

            /**
             * Method for finding members according to their memberIndex.
             * @param  {[Object]} memberIndex [description]
             * @method _findMemberByMemberIndex
             */
            _findMemberByMemberIndex: function (memberIndex) {
                return this.members.find(m => m.memberIndex === memberIndex);
            },

            /**
             * Method for building the Cubbles manifest.
             * @return {[Object]} completed manifest
             * @method _buildManifest
             */
            _buildManifest: function () {

                var manifest = {
                    'name': this.generalData && this.generalData.name || '',
                    'groupId': this.generalData && this.generalData.groupId || '',
                    'version': this.generalData && this.generalData.version || '',
                    'modelVersion': '8.3.0' || '',
                    'license': 'MIT' || '',
                    'docType': 'webpackage' || '',
                    'keywords': this.generalData && this.generalData.keywords || '',
                    'authors': [{
                        'name': this.generalData && this.generalData.author || '',
                        'email': this.generalData && this.generalData.email || ''
                    }],
                    'artifacts': {}
                };

                // Add manifest.artifacts
                manifest.artifacts['apps'] = [];
                manifest.artifacts['elementaryComponents'] = [];
                manifest.artifacts['compoundComponents'] = [];
                manifest.artifacts['utilities'] = [];

                var artifact = {
                  'artifactId': this.generalData && this.generalData.artifactId || '',
                  'description': this.generalData && this.generalData.description || '',
                  'runnables': [],
                  'endpoints': this.artifactEndpoints,
                  'members': this.artifactMembers,
                  'slots': this.artifactSlots,
                  'connections': this.artifactConnections,
                  'inits': this.artifactInits
                };

                manifest.artifacts.compoundComponents.push(artifact);

                if (manifest.name !== '' && manifest.groupId !== '' && this.members.length > 0) {
                    this.set('manifest', manifest);
                    this.manifestComplete = true;
                    this.fire('manifest-ready', { manifest: manifest });
                } else if (manifest.name === '' && manifest.groupId === '') {
                    this.manifestComplete = false;
                    this.$.noProjPropToast.open();
                } else if (this.members.length == 0) {
                    this.manifestComplete = false;
                    this.$.noMembersToast.open();
                }

            }

        }); // end of Polymer

    </script>

</dom-module>
