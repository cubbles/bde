<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel='import' href='../../vendor/paper-button/paper-button.html'/>
<link rel='import' href='../../vendor/paper-radio-group/paper-radio-group.html'/>
<link rel='import' href='../../vendor/paper-radio-button/paper-radio-button.html'/>
<link rel='import' href='../../vendor/paper-input/paper-input.html'/>
<link rel="import" href="../../vendor/Sortable/Sortable.html">
<link rel="import" href="../../vendor/paper-icon-button/paper-icon-button.html"/>
<link rel="import" href="../../vendor/paper-drawer-panel/paper-drawer-panel.html"/>
<link rel="import" href="../../vendor/iron-selector/iron-selector.html" />
<link rel="import" href="../../vendor/iron-icon/iron-icon.html" />
<link rel="import" href="../../vendor/paper-item/paper-icon-item.html" />
<link rel="import" href="../../vendor/paper-item/paper-item-body.html" />
<link rel="import" href="../../vendor/iron-collapse/iron-collapse.html" />
<link rel="import" href="../../vendor/iron-media-query/iron-media-query.html" />
<link rel="import" href="../../vendor/iron-icons/iron-icons.html" />
<!--

`bde-flexbox-layouter` is the flexbox editor for compound templates

@author Christian Saul <saul@idmt.fraunhofer.de>

-->

<dom-module id="bde-flexbox-layouter">
    <template>
        <style is="custom-style">
            :host {
                display: block;
            }

            .sortable {
                margin: 20px;
                min-height: 40px;
                background-color: white;
                border: 1px dashed lightgrey;
            }

            .sortable:not(.selected) {
                cursor: pointer;
            }

            .sortable > * {
                margin: 0;
                display: inherit;
                cursor: pointer;
                padding: 10px;
                background-color: white;
                border: 1px solid black;
                float: left;
            }

            .sortable > * i, .flexbox > i {
                cursor: pointer;
                transition: opacity .2s;
                opacity: 0;
                color: white;
                background-color: #1db1cc;
                font-style: normal;
                position: relative;
                top: -19px;
                right: -19px;
                min-width: 20px;
                height: 20px;
                border-radius: 10px;
                font-size: 16px;
                line-height: 21px;
                text-align: center;
            }

            .flexbox > i {
                display: inline-block;
                padding: 0;
                border: none;
                float: right;
                margin: -53px 30px 0 0;
            }

            .sortable > *:hover > i, .flexbox:hover > i{
                opacity: 1;
            }

            .ghost {
                color: white !important;
                background: #1db1cc !important;
            }

            .container {
                margin-top: 15px;
                cursor: pointer;
            }

            .container:focus {
                outline: 0;
            }

            .container > span {
                color: var(--bde-explorer-heading-text-color, --primary-text-color);

                @apply(--paper-font-body2);
            }

            .container > .count {
                color: var(--secondary-text-color);

                @apply(--paper-font-caption);
            }

            small {
                font-weight: normal;
            }

            .hidden {
                display: none;
            }

            .selected, .member-selected {
                background-color: var(--paper-grey-100) !important;
            }

            .add-flexbox {
                margin-left: 20px;
            }
        </style>

        <paper-drawer-panel
                right-drawer
                drawer-width="400px"
                disable-swipe
                disable-edge-swipe>

            <div drawer>

                <h2>Flexbox Layouter</h2>
                <p>This tool allows you to lay out, align and distribute space among members (i.e., elementaries
                    or utilities) in a compound, even when their size is unknown and/or dynamic.</p>
                <strong hidden$="[[selectedCompound]]">Please select a compound in the webpackage explorer</strong>
                <div hidden$="[[!selectedCompound]]" class="container" tabindex="0" on-tap="toggleCompoundMembers">
                    <iron-icon icon="[[calculateToggleIcon(compoundMembersOpen)]]"></iron-icon>
                    <span>Compound Members</span>
                    <span class="count">([[selectedCompound.members.length]])</span>
                </div>
                <p hidden$="[[!selectedCompound]]">By clicking the + Button next to the member, it will be added to the box selected (the first box is selected by default).</p>
                <iron-collapse opened="[[compoundMembersOpen]]" hidden$="[[!selectedCompound]]">
                    <template is="dom-repeat" items="[[selectedCompound.members]]">
                        <paper-icon-item>
                            <iron-icon icon="[[calculateMemberIcon(item.componentId)]]" item-icon>
                            </iron-icon>
                            <paper-item-body>
                                <div>[[item.memberId]]</div>
                            </paper-item-body>
                            <paper-icon-button id="[[trimComponentId(item.componentId)]]-add-button"
                                               icon="icons:add" alt="Add member to template"
                                               data-args="[[trimComponentId(item.componentId)]],[[item.memberId]]"
                                               on-tap="addMember">
                            </paper-icon-button>
                        </paper-icon-item>
                    </template>
                </iron-collapse>

                <div class="container" tabindex="0" on-tap="toggleLayoutSettings" hidden$="[[!selectedCompound]]">
                    <iron-icon icon="[[calculateToggleIcon(layoutSettingsOpen)]]"></iron-icon>
                    <span>Layout Settings</span>
                </div>
                <iron-collapse opened="[[layoutSettingsOpen]]" hidden$="[[!selectedCompound]]">
                    <div class="controls-wrapper">
                        <div class="controls-wrapper-buttons">
                            <div>
                                <h3>
                                    Direction
                                    <small>Specifies the direction of the members</small>
                                </h3>
                                <paper-radio-group selected="{{flexDirection}}">
                                    <paper-radio-button name="row">Horizonal</paper-radio-button>
                                    <paper-radio-button name="row-reverse">Horizonal Reverse</paper-radio-button>
                                    <paper-radio-button name="column">Vertical</paper-radio-button>
                                    <paper-radio-button name="column-reverse">Vertical Reverse</paper-radio-button>
                                </paper-radio-group>
                            </div>
                            <div id="justify-content">
                                <h3>
                                    Justify Content
                                    <small>Aligns the members when they do not use all available space horizontally
                                    </small>
                                </h3>
                                <paper-radio-group selected="{{justifyContent}}">
                                    <paper-radio-button name="flex-start">Left</paper-radio-button>
                                    <paper-radio-button name="flex-end">Right</paper-radio-button>
                                    <paper-radio-button name="center">Center</paper-radio-button>
                                    <paper-radio-button name="space-between">Space Between</paper-radio-button>
                                    <paper-radio-button name="space-around">Space Around</paper-radio-button>
                                </paper-radio-group>
                            </div>
                            <div id="wrap">
                                <h3>
                                    Wrap
                                    <small>Specifies whether the members should wrap or not</small>
                                </h3>
                                <paper-radio-group selected="{{flexWrap}}">
                                    <paper-radio-button name="nowrap">No Wrap</paper-radio-button>
                                    <paper-radio-button name="wrap">Wrap</paper-radio-button>
                                    <paper-radio-button name="wrap-reverse">Wrap Reverse</paper-radio-button>
                                </paper-radio-group>
                            </div>
                            <div id="align-items">
                                <h3>
                                    Align Items
                                    <small>Specifies the default alignment for members</small>
                                </h3>
                                <paper-radio-group selected="{{alignItems}}">
                                    <paper-radio-button name="flex-start">Left</paper-radio-button>
                                    <paper-radio-button name="flex-end">Right</paper-radio-button>
                                    <paper-radio-button name="center">Center</paper-radio-button>
                                    <paper-radio-button name="baseline">Baseline</paper-radio-button>
                                    <paper-radio-button name="stretch">Stretch</paper-radio-button>
                                </paper-radio-group>
                            </div>
                            <!--<div>-->
                            <!--<h3>-->
                            <!--Align Content-->
                            <!--<small>Modifies the behavior of the flex-wrap property</small>-->
                            <!--</h3>-->
                            <!--<paper-radio-group selected="{{alignContent}}">-->
                            <!--<paper-radio-button name="flex-start">Start</paper-radio-button>-->
                            <!--<paper-radio-button name="flex-end">End</paper-radio-button>-->
                            <!--<paper-radio-button name="center">Center</paper-radio-button>-->
                            <!--<paper-radio-button name="space-between">Space Between</paper-radio-button>-->
                            <!--<paper-radio-button name="space-around">Space Around</paper-radio-button>-->
                            <!--<paper-radio-button name="stretch">Stretch</paper-radio-button>-->
                            <!--</paper-radio-group>-->
                            <!--</div>-->
                            <div id="item-settings" class="hidden">
                                <h3>Selected Member Settings</h3>
                                <div id="flex-grow">
                                    <paper-input label="Grow" type="number" value="{{flexGrow}}" min="0"
                                                 always-float-label></paper-input>
                                    <small>Specifies how much the member will grow relative to the others (e.g., 2)</small>
                                </div>
                                <div id="flex-shrink">
                                    <paper-input label="Shrink" type="number" value="{{flexShrink}}" min="1"
                                                 always-float-label></paper-input>
                                    <small>Specifies how the member will shrink relative to the others (e.g., 2)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </iron-collapse>
            </div>

            <div main>
                <div id="flexbox-container">
                    <div class="flexbox">
                        <sortable-js group="sortable" class="sortable selected"
                                     on-sort="templateChanged" on-tap="selectFlexbox"
                                     on-add="moveMember" ghost-class="ghost">
                        </sortable-js>
                    </div>
                </div>
                <paper-icon-button class="add-flexbox" icon="icons:add" title="Add new flexbox" on-tap="addFlexbox">
                </paper-icon-button>
            </div>

        </paper-drawer-panel>
    </template>
    <script>
        Polymer({
            is: 'bde-flexbox-layouter',
            properties: {
                currentComponentMetadata: {
                    type: Object
                },
                webpackage: {
                    type: Object,
                    observer: 'webpackageChanged'
                },
                artifacts: {
                    type: Object,
                    observer: 'artifactsChanged'
                },
                selectedCompound: {
                    type: Object,
                    observer: 'selectedCompoundChanged'
                },
                compoundMembersOpen: {
                    type: Boolean,
                    value: true
                },
                layoutSettingsOpen: {
                    type: Boolean,
                    value: false
                },
                flexDirection: {
                    type: String,
                    value: 'row',
                    observer: 'flexDirectionChanged'
                },
                flexWrap: {
                    type: String,
                    value: 'wrap',
                    observer: 'flexWrapChanged'
                },
                justifyContent: {
                    type: String,
                    value: 'flex-start',
                    observer: 'justifyContentChanged'
                },
                alignItems: {
                    type: String,
                    value: 'flex-start',
                    observer: 'alignItemsChanged'
                },
                /*alignContent: {
                 type: String,
                 value: 'flex-start',
                 observer: 'alignContentChanged'
                 },*/
                flexGrow: {
                    type: String,
                    observer: 'flexGrowChanged'
                },
                flexShrink: {
                    type: String,
                    observer: 'flexShrinkChanged'
                }
            },
            ready: function () {
                var sortable = this.$$('.sortable');
                Polymer.dom(sortable).observeNodes(this.templateChanged.bind(this));
            },
            webpackageChanged: function (webpackage) {
                //this.clearContainer();
            },
            selectedCompoundChanged: function (compound) {
                this.clearContainer();
            },
            clearContainer: function () {
                var container = this.$$('#flexbox-container'),
                        flexboxes = Polymer.dom(container).querySelectorAll('.flexbox');

                for (var i = 0; i < flexboxes.length; i++) {
                    var sortable = Polymer.dom(flexboxes[i]).querySelector('.sortable'),
                            nodes = Polymer.dom(flexboxes[i]).querySelectorAll('.member');
                    // Restore members
                    for (let i = 0; i < nodes.length; i++) {
                        let name = nodes[i].nodeName.toString().toLowerCase();
                        this.$$('#' + name + '-add-button').classList.remove('hidden');
                    }
                    // Remove flexbox
                    if (i > 0) {
                        Polymer.dom(container).removeChild(flexboxes[i]);
                    } else {
                        for (let n = 0; n < nodes.length; n++) {
                            Polymer.dom(sortable).removeChild(nodes[n]);
                        }
                        sortable.style.display = 'flex';
                        sortable.style.flexDirection = 'row';
                        this.flexDirection = sortable.style.flexDirection;
                        sortable.style.flexWrap = 'wrap';
                        this.flexWrap = sortable.style.flexWrap;
                        sortable.style.justifyContent = 'flex-start';
                        this.justifyContent = sortable.style.justifyContent;
                        sortable.style.alignItems = 'flex-start';
                        this.alignItems = sortable.style.alignItems;
                    }
                }
                // Select first flexbox
                this.$$('.sortable').classList.add('selected');
                this.templateChanged();
            },
            flexDirectionChanged: function (value) {
                var container = this.$$('.sortable.selected');
                container.style.display = 'flex';
                container.style.flexDirection = value;

                if (value == 'row' || value == 'row-reverse') {
                    this.$$('#justify-content').classList.remove('hidden');
                    this.$$('#align-items').classList.add('hidden');
                    this.$$('#wrap').classList.remove('hidden');
                } else {
                    this.$$('#justify-content').classList.add('hidden');
                    this.$$('#align-items').classList.remove('hidden');
                    this.$$('#wrap').classList.add('hidden');
                }
                this.templateChanged();
            },
            flexWrapChanged: function (value) {
                var container = this.$$('.sortable.selected');
                container.style.display = 'flex';
                container.style.flexWrap = value;

                if (value == 'nowrap') {
                    this.$$('#flex-shrink').classList.remove('hidden');
                } else {
                    this.$$('#flex-shrink').classList.add('hidden');
                }
                this.templateChanged();
            },
            justifyContentChanged: function (value) {
                var container = this.$$('.sortable.selected');
                container.style.display = 'flex';
                container.style.justifyContent = value;
                this.templateChanged();
            },
            alignItemsChanged: function (value) {
                var container = this.$$('.sortable.selected');
                container.style.display = 'flex';
                container.style.alignItems = value;
                this.templateChanged();
            },
            /* Requires to set the height of the container
             this.$$('#flexbox-container').offsetHeight;
             alignContentChanged: function (value) {
             var container = this.$$('#flexbox-container');
             container.style.display = 'flex';
             container.style.alignContent = value;
             },*/
            flexGrowChanged: function (value) {
                var item = this.$$('.member-selected');
                if (item) item.style.flexGrow = value;
                this.templateChanged();
            },
            flexShrinkChanged: function (value) {
                var item = this.$$('.member-selected');
                if (item) item.style.flexShrink = value;
                this.templateChanged();
            },
            toggleCompoundMembers: function () {
                this.layoutSettingsOpen = false;
                this.compoundMembersOpen = !this.compoundMembersOpen;
            },
            toggleLayoutSettings: function () {
                this.compoundMembersOpen = false;
                this.layoutSettingsOpen = !this.layoutSettingsOpen;
            },
            calculateToggleIcon: function (state) {
                return state ? 'icons:arrow-drop-down' : 'icons:arrow-drop-up';
            },
            calculateMemberIcon: function (componentId) {
                var artifactId = this.trimComponentId(componentId);

                for (var key in this.webpackage.artifacts.elementaryComponents) {
                    if (this.webpackage.artifacts.elementaryComponents[key]['artifactId'] == artifactId) {
                        return 'icons:donut-large';
                    }
                }
                for (var key in this.webpackage.artifacts.utilities) {
                    if (this.webpackage.artifacts.utilities[key]['artifactId'] == artifactId) {
                        return 'icons:extension';
                    }
                }
                return 'icons:cloud';
            },
            trimComponentId: function (componentId) {
                return  componentId.substring(componentId.indexOf('/') + 1)
            },
            addMember: function (event) {
                var args = Polymer.dom(event).localTarget.dataArgs.split(','),
                        componentId = args[0],
                        memberId = args[1],
                        sortable = this.$$('.sortable.selected'),
                        member = document.createElement(componentId),
                        removeButton = document.createElement('i');

                Polymer.dom(sortable).appendChild(member);
                member.setAttribute('class', 'member style-scope bde-flexbox-layouter');
                member.setAttribute('member-id-ref', memberId);
                member.innerHTML = memberId;
                member.addEventListener('tap', this.selectMember.bind(this));
                Polymer.dom(member).appendChild(removeButton);
                removeButton.setAttribute('class', 'style-scope bde-flexbox-layouter');
                removeButton.innerHTML = '✖';
                removeButton.addEventListener('tap', this.removeMember.bind(this));
                // Hide add button
                Polymer.dom(event).localTarget.classList.add('hidden');
            },
            addFlexbox: function () {
                var container = this.$$('#flexbox-container'),
                        flexbox = document.createElement('div'),
                        sortable = document.createElement('sortable-js'),
                        removeButton = document.createElement('i');

                Polymer.dom(flexbox).appendChild(sortable);
                Polymer.dom(flexbox).appendChild(removeButton);
                Polymer.dom(container).appendChild(flexbox);
                flexbox.setAttribute('class', 'flexbox style-scope bde-flexbox-layouter');
                sortable.setAttribute('class', 'sortable style-scope bde-flexbox-layouter');
                sortable.setAttribute('group', 'sortable');
                sortable.setAttribute('ghost-class', 'ghost');
                sortable.style.display = 'flex';
                sortable.style.flexDirection = 'row';
                sortable.style.flexWrap = 'wrap';
                sortable.style.justifyContent = 'flex-start';
                sortable.style.alignItems = 'flex-start';
                sortable.addEventListener('tap', this.selectFlexbox.bind(this));
                sortable.addEventListener('sort', this.templateChanged.bind(this));
                sortable.addEventListener('add', this.moveMember);
                Polymer.dom(sortable).observeNodes(this.templateChanged.bind(this));
                removeButton.setAttribute('class', 'style-scope bde-flexbox-layouter');
                removeButton.innerHTML = '✖';
                removeButton.addEventListener('tap', this.removeFlexbox.bind(this));
                this.templateChanged();
            },
            selectFlexbox: function (event) {
                var selectedElements = Polymer.dom(event).localTarget.parentNode.parentNode.querySelectorAll('.selected');
                for (let i = 0; i < selectedElements.length; i++) {
                    selectedElements[i].classList.remove('selected');
                }
                Polymer.dom(event).localTarget.classList.add('selected');
                // Update flexbox settings
                this.flexDirection = Polymer.dom(event).localTarget.style.flexDirection;
                this.flexWrap = Polymer.dom(event).localTarget.style.flexWrap;
                this.justifyContent = Polymer.dom(event).localTarget.style.justifyContent;
                this.alignItems = Polymer.dom(event).localTarget.style.alignItems;
                this.$$('#item-settings').classList.add('hidden');
            },
            removeFlexbox: function (event) {
                var container = this.$$('#flexbox-container'),
                        flexbox = Polymer.dom(event).localTarget.parentNode,
                        sortable = Polymer.dom(flexbox).querySelector('.sortable'),
                        nodes = Polymer.dom(flexbox).querySelectorAll('.member');
                // Restore members
                for (let i = 0; i < nodes.length; i++) {
                    let name = nodes[i].nodeName.toString().toLowerCase();
                    this.$$('#' + name + '-add-button').classList.remove('hidden');
                }
                // If the flexbox to be removed is selected, select first by default
                if (sortable.classList.contains('selected')) {
                    this.$$('.sortable').classList.add('selected');
                }
                // Remove flexbox
                Polymer.dom(container).removeChild(flexbox);
                this.templateChanged();
            },
            selectMember: function (event) {
                var selectedElements = Polymer.dom(event).localTarget.parentNode.parentNode.querySelectorAll('.member-selected');
                for (let i = 0; i < selectedElements.length; i++) {
                    selectedElements[i].classList.remove('member-selected');
                }
                Polymer.dom(event).localTarget.classList.add('member-selected');
                this.$$('#item-settings').classList.remove('hidden');
                this.flexGrow = Polymer.dom(event).localTarget.style.flexGrow;
                this.flexShrink = Polymer.dom(event).localTarget.style.flexShrink;
                event.stopPropagation();
            },
            moveMember: function (event) {
                var from = Polymer.dom(event).event.from,
                        to = Polymer.dom(event).event.to,
                        member = Polymer.dom(event).event.item;

                if (from && to && member) {
                    Polymer.dom(from).removeChild(member);
                    Polymer.dom(to).appendChild(member);
                }
            },
            removeMember: function (event) {
                // Restore add button
                var name = Polymer.dom(event).localTarget.parentNode.nodeName.toString().toLowerCase();
                this.$$('#' + name + '-add-button').classList.remove('hidden');
                // Remove member
                var flexbox = Polymer.dom(event).localTarget.parentNode.parentNode,
                        member = Polymer.dom(event).localTarget.parentNode;
                Polymer.dom(flexbox).removeChild(member);
            },
            templateChanged: function () {
                console.log('<bde-flexbox-layouter>::templateChanged', this.getTemplate());
//                if (!this.selectedCompound || !this.webpackage || this.getTemplate().outerHTML === '') {
//                    return;
//                }
//                window.URL = window.URL || window.webkitURL;
//                var blob = new Blob([this.getTemplate().outerHTML], {type: 'text/html'});
//                var templateBlobUrl = window.URL.createObjectURL(blob) + '?type=html';
//                var artifactId = this.selectedCompound.artifactId;
//                var endpoints = this.webpackage.artifacts.compoundComponents[artifactId].endpoints;
//
//                var endpointId = currentComponentMetadata.endpoint.substring(currentComponentMetadata.endpoint.lastIndex('/')+1);
//                var endpoint;
//                endpoints.forEach(function(item){
//                    if(item.endpointId === endpointId){
//                        endpoint = item;
//                    }
//                });
//                var listToDelete = [];
//                endpoint.resources.forEach(function(item){
//                    if (item.indexOf('.html')> -1){
//                        listToDelete.push(item);
//                    }
//                });
//                listToDelete.forEach(function(item){
//                    endpoint.resources.splice(endpoint.resources.indexOf(item));
//                });
//
//                endpoint.resources.push(templateBlobUrl);
            },
            getTemplate: function () {
                //var container = this.$$('#flexbox-container').cloneNode(true);
                var flexboxes = Polymer.dom(this.root).querySelectorAll('.sortable'),
                        template = document.createElement('template');

                for (let i = 0; i < flexboxes.length; i++) {
                    let flexbox = flexboxes[i].cloneNode(true),
                            div = document.createElement('div');
                    template.content.appendChild(div);
                    while (flexbox.hasChildNodes()) {
                        if (flexbox.firstChild.nodeName.toString().toLowerCase() != 'i') {
                            Polymer.dom(div).appendChild(flexbox.removeChild(flexbox.firstChild));
                        } else {
                            flexbox.removeChild(flexbox.firstChild);
                        }
                    }
                    for (let ii = 0; ii < div.children.length; ii++) {
                        div.children[ii].removeAttribute('class');
                        div.children[ii].removeAttribute('draggable');
                        div.children[ii].innerHTML = '';
                    }
                }
                return template;
            }
        });
    </script>
</dom-module>
