<!-- libraries -->
<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/iron-ajax/iron-ajax.html">
<!-- possibly a different library need for json querying -->
<script src="../../vendor/jsonpath-plus/lib/jsonpath-min.js" type="text/javascript"></script>
<!-- <script src="../../vendor/lodash/lodash.min.js"></script> -->

<!--
# Deprecated

This element is deprecated and will be removed in the next version.
It has been replaced with `bde-artifact-parser`

(ene) TODO: this element is deprecated !

A BDE custom element, parsing the result of the bde-repository-browser, to provide them to the BDE-app.
For this the element listens to the "repository-item.addObject"-event and calls bde-model-store.addMember function, when parsing is done.

Feature-Improvement: The functionality of the bde-basedoc-parser could be implemented directly in the bde-repository-browser,
or the bde-repository-item respectively.

Example:

    <bde-basedoc-parser></bde-basedoc-parser>

@group BDE Custom Elements
@hero hero.svg
@element bde-basedoc-parser
@demo demo/index.html
-->
<dom-module id="bde-basedoc-parser">

    <template>
       <!-- <iron-ajax
            auto
            id="elementaryItem"
            handle-as="json"
            url=  {{memberurl}}
            on-response="getOneMember"

           >
        </iron-ajax>-->
    </template>
</dom-module>

<script>

    Polymer({

        is : 'bde-basedoc-parser',

        properties : {

          metadata : {
            type : Object
          },

          inslots : {
            type : Object
          },

          outslots : {
            type : Object
          },

          id : {
            type : String
          },

          memberurl:{
              type : String
          },

          members: {},

          connections: {},

          membersWithIndex:{
              type: Array,
              notify: true,
              value : []
          },

          showCompoundMembers:
          {
              type: Boolean,
              value : false
          },

          /**
           * Metadata for the created compound component.
           *
           * @property generalData
           * @type Object
           */
          generalData: {
              type: Object,
              notify: true
          }

        },


        /**
         * Polymer ready function, adds event listener for addBaseObject event and starts parsing.
         */
        attached: function() {

          addEventListener('repository-item.addObject', function(evt){
            this.metadata = evt.detail.baseObject;

              if(this.metadata["manifest.component"].type == 'compound')
              {
                  if(this.showCompoundMembers)
                  {
                      this.getCompoundMembers();
                      this.getConnections();
                      this.setWebpackDoc();
                      document.querySelector('bde-graph').triggerAutolayout(true);
                  }
                  else
                  {
                      this.id = this.metadata.name;
                      this.getSlots();
                      this.addElementaryMember();
                  }

          }
           else {
                this.id = this.metadata.name;
                this.getSlots();
                this.addElementaryMember();
            }

        }.bind(this))
        },

        /**
         * Sets inslots and outslots from the slot array of the couchDB document.
         *
         * @method getSlots
         */
        getSlots : function(){
          var slots = jsonPath.eval(this.metadata, '$..slots.*')
          var slotNames = jsonPath.eval(this.metadata, '$..slots.*.name')

          // BDE-184: convert slot names to lower case
          slotNames.forEach(function(name, index){
            slots[index].originalName = name;
            name = name.toLowerCase();
            slots[index].name = name;
          })

            this.inslots =  slots.filter(slot =>
                slot.direction.indexOf('input') != -1
            );
            this.outslots =  slots.filter(slot =>
                slot.direction.indexOf('output') != -1
            );
        },

      /**
       * Sets member as an object with id, inslots, outslots and metadata, while metadata contain the original couchdbDoc and calls addMember function of modelStore.
       *
       * @method addMember
       */
        addElementaryMember: function (){
          var metadata = {'couchDbDoc' : this.metadata}
          var bdeMs = document.querySelector('bde-model-store')
          bdeMs.addMember(this.metadata['_id'], this.id, this.inslots, this.outslots, metadata)
        },
        getCompoundMembers:function(){
            this.membersWithIndex=[];
            this.members=[];
            this.connections =[];
            //all of members od Compound
            this.members = jsonPath.eval(this.metadata["manifest.component"], '$..member.*');
            // all of Connections of Compound
            this.connections = jsonPath.eval(this.metadata["manifest.component"], '$..connections.*');
            for(var index in this.connections){
              this.connections[index].destination.slot = this.connections[index].destination.slot.toLowerCase();
              this.connections[index].source.slot = this.connections[index].source.slot.toLowerCase();
            }
//            // number of members
//            this.memCount = this.members.length;
//            this.memNum = 0;
            var modelStoreMem;
            this.members.forEach( function(mem){
                  this.memberurl ="https://webblebase.net/"+mem.id;
                 //this.$.elementaryItem.generateRequest();
                modelStoreMe = this.syncGetMember(this.memberurl);
                modelStoreMe.memberIndex = mem.memberIndex
                //if(this.memNum < this.memCount){
                    this.membersWithIndex.push(modelStoreMe)
                //}
            }.bind(this));



        },


        syncGetMember: function(url)
        {
        var request = new XMLHttpRequest();
        request.open('GET',url, false);  // `false` makes the request synchronous
        request.send(null);

        if (request.status === 200) {
            // TODO (ene): remove couchDB attributes (_id, _rev, attachments)
            this.metadata = JSON.parse(request.responseText);
            this.id = this.metadata.name;
            //this.id = this.metadata.groupId + '.' + this.metadata.name + '-' + this.metadata.version;
            this.getSlots(this.metadata);
            var metadata = {'couchDbDoc': this.metadata}
            // this.fire('addMember', {member : member})
            var bdeMs = document.querySelector('bde-model-store')
            return bdeMs.addMember(this.metadata['_id'], this.id, this.inslots, this.outslots, metadata);
        }
        },

        getConnections:function()
        {
            this.connections.forEach( function(con){
            var bdeMs = document.querySelector('bde-model-store')
            if(con.source.member  === undefined)
                bdeMs.addInslot(con.source.slot,Object,this.getMemberId(con.destination.member,this.membersWithIndex).id, con.destination.slot, null)

            else if(con.destination.member === undefined)
                bdeMs.addOutslot(con.destination.slot, Object,this.getMemberId(con.source.member,this.membersWithIndex).id, con.source.slot, null)

           else
                bdeMs.addConnection(this.getMemberId(con.source.member, this.membersWithIndex).id, con.source.slot, this.getMemberId(con.destination.member, this.membersWithIndex).id, con.destination.slot)

        }.bind(this))

        },
        // find memberId according to mamberIndex
        getMemberId:function(memberIndex, members){

            return _.find(members, function(m) { return m.memberIndex == memberIndex;
                })
        },
        //call back funcrion of iron-ajax return a member
        getOneMember : function(evt, responseData){

            // TODO (ene): remove couchDB attributes (_id, _rev, attachments)
            this.metadata  = responseData.response;
            this.id = this.metadata.name;
           //this.id = this.metadata.groupId + '.' + this.metadata.name + '-' + this.metadata.version;
            this.getSlots(this.metadata);
            var metadata = {'couchDbDoc' : this.metadata}
            // this.fire('addMember', {member : member})
            var bdeMs = document.querySelector('bde-model-store')
            this.storeMem = bdeMs.addMember(this.metadata['_id'], this.id, this.inslots, this.outslots, metadata)
            /*if(this.memNum < this.memCount){
                //storeMem.memberIndex = this.members[this.memNum].memberIndex
                this.membersWithIndex.push(storeMem)
            }
            */
            this.memNum++;// async Problem of ajax----if all members are ready conncetion is called
            if(this.memNum == this.memCount)
                this.getConnections();

        },

        setWebpackDoc:function() {

            var webpackData = {};

            webpackData.name = this.metadata.name;
            webpackData.groupId = this.metadata.groupId;
            webpackData.version = this.metadata.version;
            webpackData.selectedLicense = this.metadata.license;
            webpackData.description = this.metadata.description;
            webpackData.author = this.metadata.authors[0].name;
            webpackData.email = this.metadata.authors[0].email;

            var keywords='';
            this.metadata.keywords.forEach(function (keyword) {
                keywords += keyword + ', ';
            })
            keywords = keywords.substring(0, (keywords.length - 2));

            webpackData.keywords = keywords;

            this.set('generalData', webpackData);
        }

    });

</script>
