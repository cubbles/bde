<link rel="import" href="../../vendor/polymer/polymer.html">

<script>
(function() {
    'use strict';

    var key;
    var instances = [];
    var vars = Object.create(Polymer.Base);

    Polymer({
        is: 'app-data',

        properties: {

            data: {
                type: Object,
                notify: true
            },

            key: {
                type: String
            }
        },

        created: function() {
            key = this.getAttribute('key');
            if (!key) {
                throw new Error("created: `<app-data>` requires key attribute");
            }

            instances.push({key: key, instance: this});
        },

        ready: function() {
            var i = instances.find(i => i.key == key);
            if (i && i.instance !== this) {
                this.set('data', i.instance.data);
            }
        },

        detached: function() {
            key = this.getAttribute('key');
            var i = instances.indexOf({key: key, instance: this});
            if (i >= 0) {
                instances.splice(i, 1);
            }
        },

        _dataChanged: function(newValue, oldValue) {
            var i;

            key = this.getAttribute('key');
            if (!key) {
                throw new Error("_dataChanged: `<app-data>` requires key attribute");
            }
            vars.set(key, newValue);

            // Notify the instances with the correct key
            i = instances.length
            while (instances[--i]) {
                if (instances[i].key === key) {
                    instances[i].instance.notifyPath('data', newValue);
                }
            }
        }
    });
})();
</script>
