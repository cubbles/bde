<!-- libraries -->
<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/font-roboto/roboto.html"/>

<!-- paper elements -->
<link rel="import" href="../../vendor/paper-item/paper-item.html">
<link rel="import" href="../../vendor/paper-fab/paper-fab.html">
<link rel="import" href="../../vendor/paper-item/paper-item-body.html">

<!-- iron elements -->
<link rel="import" href="../../vendor/iron-icons/iron-icons.html">
<link rel="import" href="../../vendor/iron-ajax/iron-ajax.html">
<link rel="import" href="../../vendor/iron-flex-layout/iron-flex-layout.html">

<script src="../../vendor/inflection/inflection.min.js"></script>

<!--
A BDE custom-element providing an item containing a name and a description, and a button, which fires an event containing a data-object.

Example:

    <bde-repository-item
        item="{{item}}"
        last-item-selected="{{addedItem}}"
        manifest="{{manifest}}">
    </bde-repository-item>

@group BDE Custom Elements
@element bde-repository-item
-->
<dom-module id="bde-repository-item">

  <style>
      :host {
          display: block;
          border-bottom: 1px solid #e5e5e5;
          cursor: pointer;
      }

      :host:hover {
          background: #e1e1e1;
      }

  </style>

  <template>

    <iron-ajax
      id="itemRequest"
      url="[[getItemUrl(item)]]"
      handle-as="json"
      on-response="handleResponse">
    </iron-ajax>

    <paper-icon-item class="layout horizontal row" on-tap="addComponent">
      <iron-icon icon="image:remove-red-eye" item-icon></iron-icon>

      <paper-item-body three-line>

        <div>[[item.artifactId]]</div>

        <div secondary>[[item.webpackageId]]</div>

        <div secondary>[[item.artifactDescription]]</div>

      </paper-item-body>
    </paper-icon-item>

  </template>

  <script>
  Polymer({
    'is': 'bde-repository-item',

    properties: {

      /**
       * Object containing the couchDB data retrieved by the initial request to the Base via bde-repository-browser.
       *
       * @type Object
       * @property item
       */
      item: {
        type: Object,
        value: function () {
          return {};
        }
      },

      /**
       * Object containing couchDB data for the given component. Used for databinding the component data to the other bde-elements.
       *
       * @type Object
       * @property lastItemSelected
       */
      lastItemSelected: {
        type: Object,
        notify: true
      },

      /**
       * Object to store the couchDB data for the given component. For later use in the bde-creator.
       *
       * @type Object
       * @property manifest
       */
      manifest: {
        type: Object,
        notify: true
      },

      /**
       * Holding the BDE Application settings. (see <bde-app> component)
       */
      settings: {
          type: Object
      }

    },

    /**
     * Method invoked on click for the given component. Generates new AJAX request to retrieve the data for component from the couchDB.
     *
     * @method addComponent
     */
    addComponent: function () {
      this.$.itemRequest.generateRequest();
    },

    /**
     * Method gets the URL for the given component based on the retrieved metadata from initail search request.
     *
     * @method getItemUrl
     * @param  {Object} item metadata of initail request
     * @return {String} url URL ind Base for the given component
     */
    getItemUrl: function (item) {
      var url = this.get('settings.baseUrl') + '/' + this.get('settings.store') + '/' + item.webpackageId + '/manifest.webpackage';
      return url;
    },

    /**
     * Handles the AJAX response of the iron-ajax element. Sets the data for the given component for data-binding with other bde elements.
     *
     * @method handleResponse
     * @param  {Event} event The iron-ajax respons event.
     */
    handleResponse: function (event) {
        var manifest = this.$.itemRequest.lastResponse;
        var path = inflection.pluralize(this.item.artifactType);
        var artifact = manifest.artifacts[path]
            .find(artifact => artifact.artifactId === this.item.artifactId);

        if (!artifact) {
            throw new Error("Something went wrong finding our artifact in the webpackage");
        }

        artifact.is = this.item.artifactType;
        artifact.metadata = {
          url: this.getItemUrl(this.item),
          webpackageId: getWebpackageId(this.item)
        };

        this.set('lastItemSelected', artifact);
        document.querySelector('#manifest').loadManifest(manifest);

        return;

        function getWebpackageId (item) {
          return item.groupId + '.' + item.name + '@' + item.version;
        }

    }

  });
  </script>

</dom-module>
